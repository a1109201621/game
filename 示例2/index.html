<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game</title>
    <script>(function () {
            'use strict';
            function l(r) {
                if (r == null || typeof r != 'object') return r;
                try {
                    return JSON.parse(JSON.stringify(r));
                } catch {
                    return r;
                }
            }
            var o = class {
                constructor(e, s = window) {
                    this.targetWindow = e;
                    this.sourceWindow = s;
                    this.listeners = new Map();
                    this.streamListeners = new Map();
                    this.messageHandler = null;
                }
                start(e) {
                    this.messageHandler ||
                        ((this.messageHandler = async (s) => {
                            if (s.source !== this.targetWindow) return;
                            let t = s.data;
                            if (t.type === 'dzmm:response') {
                                let n = this.listeners.get(t.id);
                                n &&
                                    (this.listeners.delete(t.id),
                                        t.error ? n(Promise.reject(new Error(t.error))) : n(t.result));
                            } else if (t.type === 'dzmm:stream') {
                                let n = this.streamListeners.get(t.id);
                                n && (n(t.content, t.done), t.done && this.streamListeners.delete(t.id));
                            } else t.type === 'dzmm:request' && e && (await e(t));
                        }),
                            this.sourceWindow.addEventListener('message', this.messageHandler));
                }
                stop() {
                    this.messageHandler &&
                        (this.sourceWindow.removeEventListener('message', this.messageHandler),
                            (this.messageHandler = null)),
                        this.listeners.clear(),
                        this.streamListeners.clear();
                }
                send(e) {
                    this.targetWindow.postMessage(e, '*');
                }
                request(e, s = {}) {
                    let t = `${Date.now()}-${Math.random().toString(36).slice(2)}`;
                    return new Promise((n, i) => {
                        this.listeners.set(t, (a) => {
                            a instanceof Promise ? a.catch(i) : n(a);
                        }),
                            this.send({ type: 'dzmm:request', id: t, method: e, params: l(s) });
                    });
                }
                requestWithStream(e, s, t) {
                    let n = `${Date.now()}-${Math.random().toString(36).slice(2)}`,
                        i = `${n}-stream`;
                    return (
                        this.streamListeners.set(i, t),
                        new Promise((a, c) => {
                            this.listeners.set(n, (m) => {
                                m instanceof Promise ? m.catch(c) : a(m);
                            }),
                                this.send({
                                    type: 'dzmm:request',
                                    id: n,
                                    method: e,
                                    params: l({ ...s, _streamId: i }),
                                });
                        })
                    );
                }
                respond(e, s, t) {
                    this.send({ type: 'dzmm:response', id: e, result: s, error: t });
                }
                streamUpdate(e, s, t) {
                    this.send({ type: 'dzmm:stream', id: e, content: s, done: t });
                }
            };
            var d = class {
                constructor(e = window.parent) {
                    this.kv = {
                        get: (e) => this.channel.request('kv.get', { key: e }),
                        put: (e, s) => this.channel.request('kv.put', { key: e, value: s }),
                        delete: (e) => this.channel.request('kv.delete', { key: e }),
                    };
                    this.draw = { generate: (e) => this.channel.request('draw.generate', e) };
                    this.chat = {
                        list: (e) => this.channel.request('chat.list', { ids: e }),
                        insert: (e, s) => this.channel.request('chat.insert', { parentId: e, messages: s }),
                        timeline: (e) => this.channel.request('chat.timeline', { hasId: e }),
                    };
                    if (typeof window > 'u') throw new Error('GamefyBrowserSDK requires a browser environment');
                    (this.channel = new o(e, window)),
                        this.channel.start(),
                        e !== window &&
                        (e.postMessage('iframe:content-ready', '*'),
                            window.addEventListener('message', (s) => {
                                s.data?.type === 'dzmm:parent-ready' && e.postMessage('iframe:content-ready', '*');
                            }));
                }
                async completions(e, s) {
                    let t = `${Date.now()}-${Math.random().toString(36).slice(2)}`;
                    await this.channel.requestWithStream('completions', { ...e, _streamId: t }, (n, i) =>
                        s?.(n, i, t),
                    );
                }
            };
            if (typeof window < 'u')
                try {
                    let r = new d();
                    window.dzmm = r;
                } catch (r) {
                    console.error('[Gamefy SDK] Initialization failed:', r);
                }
        })();
    </script>
    <link rel="stylesheet" href="style.css">
</head>
<!--
===============================================================================

🌌 创世神：部族进步模拟器（新卡）
- ✅ 仅保留：3个手动存档位（kv）
- ✅ 去掉：自动存档（生产环境 timeline 读历史会 500）
- ✅ 模型上下文：本地 history 维护；存档时一起保存/读取
- ✅ 本地计算：信仰/进步点/模式（神明/降临）/时代/异教徒刷新与恢复/战争条件
- ✅ 战争：仅信仰全满可发动；消耗全部信仰；胜利弹窗=胜利CG(随机池) + 胜利描写
- ✅ 侦查：模型生成"同科技水平的部族信息"（解析 ###TRIBE JSON）
- ✅ 降临：进入人类形态；可点击【视察】=生成视察描写 + 播放视察CG（按时代随机池）

不动的关键点仍然保留：
- window.dzmm.completions({ model, messages, maxTokens }, cb)
- dzmm.chat.insert(parentId, [{role,content}])

===============================================================================
-->

<body x-data="">
    <!-- 字体：不要放进 style 里 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.7.0/style.css">
    <!-- 你想换字体就替换下面这行（示例：霞鹜文楷已在上面；再加一个更"神秘"的英文字体） -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&amp;display=swap" rel="stylesheet">

    <!-- 加载中 -->
    <div x-show="$store.game.loading" class="loading-wrap" style="display: none;">
        <div class="loading-card">
            <div class="spinner"></div>
            <div class="loading-title">神谕回响中...</div>
            <div class="loading-sub">读取存档与神域初始化</div>
        </div>
    </div>

    <!-- 设置界面 -->
    <div x-show="!$store.game.started &amp;&amp; !$store.game.loading" x-transition="" class="setup">
        <div class="card">
            <div class="title">🌌淫乱纪元-发展文明抢女神</div>
            <div class="desc">
                你是一个文明的神，要发展自己的文明，不断完成突破。<br>
                <b>观察</b>让他们自由发展一次；<b>天启</b>用一句神谕指挥他们；<b>侦查</b>寻找同科技水平的部族；<b>信仰全满</b>才能发动战争。<br>
                击败其他文明可以获得大量进步点数，同时把对方的女神抢来爆操。<br>
                文明点数的自然增长速度和信仰值有关，注意处理异教徒，她们会影响你的信仰。<br>
                由于涉及到输出抽取，强烈推荐XL以上的模型进行游玩。
            </div>

            <div class="form">
                <div class="form-group">
                    <label>神名（你的名讳）</label>
                    <input x-model="$store.game.godName" placeholder="请输入神名">
                </div>

                <div class="form-group">
                    <label>模型</label>
                    <select x-model="$store.game.model">
                        <option value="nalang-turbo-0826">nalang-turbo-0826</option>
                        <option value="nalang-medium-0826">nalang-medium-0826</option>
                        <option value="nalang-max-0826">nalang-max-0826</option>
                        <option value="nalang-xl-0826">nalang-xl-0826（推荐）</option>
                        <option value="nalang-max-0826-16k">nalang-max-0826-16k</option>
                        <option value="nalang-xl-0826-16k">nalang-xl-0826-16k</option>
                    </select>
                    <div class="hint">"天之声"只写文，不负责任何数值</div>
                </div>

                <div class="row">
                    <button class="btn" @click="$store.game.start()" :disabled="!$store.game.godName"
                        disabled="disabled">降下第一道神谕</button>
                    <button class="btn ghost" @click="$store.game.openSaveManager(true)">读取手动存档</button>
                </div>

                <div class="rules">
                    <div class="rules-title">玩法要点</div>
                    <ul>
                        <li>模式：<b>神明</b>（天启/观察/侦查/处理异教徒/战争/推进时代）与 <b>降临</b>（叙事模式变化，可以玩自己文明的女人，她们都很乐意哦）</li>
                        <li>信仰：0～100；无异教徒时会逐步恢复；有异教徒时会流失</li>
                        <li>进步点：满时可推进时代，推进后清空进步点</li>
                        <li>战争：仅信仰全满可发动；消耗全部信仰；胜利弹窗显示胜利CG（哐哐女神）与胜利描写</li>
                        <li>侦查：寻找同科技水平的文明</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 游戏界面 -->
    <div x-show="$store.game.started &amp;&amp; !$store.game.loading" x-transition="" class="game"
        style="display: none;">
        <!-- 顶栏 -->
        <div class="topbar">
            <div class="brand">
                <div class="brand-title">🌌 创世神</div>
                <div class="brand-sub" x-text="$store.game.godName + ' · ' + $store.game.modeName()"> · 神明状态</div>
            </div>

            <div class="top-actions">
                <button class="smallbtn ghost" @click="$store.game.openSaveManager(false)"
                    :disabled="$store.game.disabled">
                    💾 存档读档
                </button>
                <button class="smallbtn" @click="$store.game.toggleIncarnation()" :disabled="$store.game.disabled">
                    <span x-text="$store.game.mode==='god' ? '⤵ 降临' : '⤴ 回归神位'">⤵ 降临</span>
                </button>
            </div>

            <div class="stats">
                <div class="chip">
                    <div class="k">时代</div>
                    <div class="v" x-text="$store.game.eraName()">原始时代</div>
                </div>

                <div class="chip wide">
                    <div class="k">信仰</div>
                    <div class="v">
                        <span x-text="$store.game.faith">100</span>
                        <span class="muted">/</span>
                        <span x-text="$store.game.faithMax">100</span>
                        <span class="muted" x-show="$store.game.faith=== $store.game.faithMax">（可发动战争）</span>
                    </div>
                    <div class="bar">
                        <div class="fill" :style="`width:${$store.game.faithPct()}%`" style="width:100%"></div>
                    </div>
                </div>

                <div class="chip wide">
                    <div class="k">进步点</div>
                    <div class="v">
                        <span x-text="$store.game.progress">0</span>
                        <span class="muted">/</span>
                        <span x-text="$store.game.progressMax()">100</span>
                        <span class="muted" x-show="$store.game.canAdvanceEra()" style="display: none;">（可推进时代）</span>
                    </div>
                    <div class="bar">
                        <div class="fill2" :style="`width:${$store.game.progressPct()}%`" style="width:0%"></div>
                    </div>
                </div>

                <div class="chip">
                    <div class="k">异教徒</div>
                    <div class="v" x-text="$store.game.heretic.active ? '出现' : '无'">无</div>
                    <div class="tiny muted" x-show="$store.game.heretic.active" x-text="$store.game.heretic.name"
                        style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- 主体 -->
        <div class="main">
            <!-- 左：叙事 -->
            <div class="panel chat">
                <div class="panel-title">神谕与回响</div>
                <div class="panel-body">
                    <div class="speaker">旁白</div>
                    <div class="content" x-html="$store.game.chat_content || '……'">……</div>
                </div>
            </div>

            <!-- 右：控制台 -->
            <div class="panel side">
                <div class="panel-title">神域控制台</div>
                <div class="panel-body">
                    <!-- 行动区（神明状态） -->
                    <div class="section">
                        <div class="section-title">行动</div>

                        <div class="grid2" x-show="$store.game.mode==='god'">
                            <button class="actbtn" @click="$store.game.actObserve()" :disabled="$store.game.disabled">👁
                                观察</button>
                            <button class="actbtn" @click="$store.game.actScout()" :disabled="$store.game.disabled">🜂
                                侦查</button>

                            <button class="actbtn warn" @click="$store.game.actHandleHeretic()"
                                :disabled="$store.game.disabled || !$store.game.heretic.active" disabled="disabled">
                                ✦ 处理异教徒
                            </button>

                            <button class="actbtn danger" @click="$store.game.actWar()"
                                :disabled="$store.game.disabled || !$store.game.canWar()" disabled="disabled">
                                ⚔ 发动战争（仅信仰全满）
                            </button>

                            <button class="actbtn" @click="$store.game.actAdvanceEra()"
                                :disabled="$store.game.disabled || !$store.game.canAdvanceEra()" disabled="disabled">
                                ⟰ 推进时代
                            </button>

                            <button class="actbtn ghost" @click="$store.game.openTribeDrawer()"
                                :disabled="$store.game.disabled">
                                📜 侦查名单
                            </button>
                        </div>

                        <!-- 降临状态：视察 -->
                        <div class="grid2" x-show="$store.game.mode==='incarnate'" style="display: none;">
                            <button class="actbtn" @click="$store.game.actInspect()" :disabled="$store.game.disabled">🏛
                                视察</button>
                            <button class="actbtn ghost" @click="$store.game.openTribeDrawer()"
                                :disabled="$store.game.disabled">
                                📜 侦查名单
                            </button>
                        </div>

                        <!-- 天启输入（神明状态才可） -->
                        <div class="oracle" x-show="$store.game.mode==='god'">
                            <div class="oracle-title">天启</div>
                            <input x-model="$store.game.oracleInput" placeholder="写下一句神谕：如"
                                开垦河谷""铸造铁器""修建城墙""抑制内斗""远征邻邦"……" :disabled="$store.game.disabled"
                                @keydown.enter="$store.game.actOracle()">
                            <button class="actbtn full" @click="$store.game.actOracle()"
                                :disabled="$store.game.disabled || !$store.game.oracleInput.trim()" disabled="disabled">
                                🜁 降下神谕
                            </button>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- 状态日志 -->
                    <div class="section">
                        <div class="section-title">本地记录</div>
                        <div class="logrow">
                            <span class="tag">上次行动</span>
                            <span class="val" x-text="$store.game.lastAction.type || '无'">无</span>
                        </div>
                        <div class="logrow">
                            <span class="tag">信仰变化</span>
                            <span class="val" x-text="$store.game.lastAction.faithDeltaText || '无'">无</span>
                        </div>
                        <div class="logrow">
                            <span class="tag">进步变化</span>
                            <span class="val" x-text="$store.game.lastAction.progressDeltaText || '无'">无</span>
                        </div>
                        <div class="logrow">
                            <span class="tag">异教徒状态</span>
                            <span class="val" x-text="$store.game.heretic.active ? '威胁中' : '平静'">平静</span>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <div class="tiny muted">
                        - 战争按钮仅在信仰全满时点亮；点下即消耗全部信仰发动战争。<br>
                        - 视察时会有自己文明的女人主动侍奉，文字和图像风格与当前文明阶段有关。<br>
                        - 仅降临状态下可选择视察，右上角按键为降临/回归神位。
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 通用弹窗（左文字右图片）：胜利/视察/异教徒等 -->
    <div class="modal-mask" x-show="$store.game.modal.open" x-transition="" style="display: none;">
        <div class="modal">
            <div class="modal-head">
                <div class="modal-title" x-text="$store.game.modal.title"></div>
                <button class="modal-close" @click="$store.game.modal.open=false">关闭</button>
            </div>

            <!-- ✅ 关键：让 modal 内容整体可滚 -->
            <div class="modal-scroll">
                <div class="modal-body">
                    <div class="modal-text">
                        <div class="modal-text-inner" x-text="$store.game.modal.text"></div>
                    </div>
                    <div class="modal-image">
                        <img :src="$store.game.modal.imageUrl" alt="modal-img" src="">
                    </div>
                </div>

                <div class="modal-foot">
                    <div class="tiny muted" x-text="$store.game.modal.tip"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 侦查名单抽屉 -->
    <div class="drawer-mask" x-show="$store.game.tribeDrawer.open" x-transition="" style="display: none;">
        <div class="drawer">
            <div class="drawer-head">
                <div class="drawer-title">📜 侦查名单（同科技水平）</div>
                <button class="drawer-close" @click="$store.game.tribeDrawer.open=false">关闭</button>
            </div>

            <div class="drawer-body">
                <template x-if="$store.game.tribes.length===0">
                    <div class="tiny muted">暂无。点击【侦查】可生成一个新文明信息。</div>
                </template>
                <div class="tiny muted">暂无。点击【侦查】可生成一个新文明信息。</div>

                <div class="tribe-list" x-show="$store.game.tribes.length>0" style="display: none;">
                    <template x-for="t in $store.game.tribes" :key="t.id">
                        <div class="tribe-item">
                            <div class="tribe-top">
                                <div class="tribe-name" x-text="t.name"></div>
                                <div class="tribe-badges">
                                    <span class="badge" x-text="t.era"></span>
                                    <span class="badge ghost" x-text="'人口：' + (t.population || '？')"></span>
                                    <span class="badge ghost" x-text="'特质：' + (t.trait || '？')"></span>
                                </div>
                            </div>
                            <div class="tribe-desc" x-text="t.summary"></div>

                            <div class="tribe-god">
                                <div class="tiny muted">创世神：</div>
                                <div class="tribe-godname" x-text="t.godName"></div>
                                <div class="tribe-goddesc" x-text="t.godDesc"></div>
                            </div>

                            <div class="tribe-actions">
                                <button class="smallbtn" @click="$store.game.selectWarTarget(t.id)"
                                    :disabled="$store.game.disabled">
                                    设为战争目标
                                </button>
                                <button class="smallbtn ghost" @click="$store.game.removeTribe(t.id)"
                                    :disabled="$store.game.disabled">
                                    移除
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div class="drawer-foot">
                <div class="tiny muted">
                    当前战争目标：
                    <span x-text="$store.game.warTargetName()"></span>
                    <span x-show="!$store.game.warTargetId">（未选择）</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 手动存档管理弹窗 -->
    <div class="modal-mask" x-show="$store.game.saveManager.open" x-transition="" style="display: none;">
        <div class="modal">
            <div class="modal-head">
                <div class="modal-title">💾 手动存档（3个存档位）</div>
                <button class="modal-close" @click="$store.game.saveManager.open=false">关闭</button>
            </div>

            <div class="save-body">
                <template x-for="slot in [1,2,3]" :key="slot">
                    <div class="save-slot">
                        <div class="save-left">
                            <div class="save-name">存档位 <span x-text="slot"></span></div>
                            <div class="save-meta" x-text="$store.game.saveSummaryText(slot)"></div>
                        </div>
                        <div class="save-right">
                            <button class="smallbtn" @click="$store.game.manualSave(slot)"
                                :disabled="$store.game.disabled || !$store.game.started">
                                保存
                            </button>

                            <button class="smallbtn ghost" @click="$store.game.manualLoad(slot)"
                                :disabled="$store.game.disabled">
                                读取
                            </button>
                        </div>
                    </div>
                </template>
                <div class="save-slot">
                    <div class="save-left">
                        <div class="save-name">存档位 <span x-text="slot">1</span></div>
                        <div class="save-meta" x-text="$store.game.saveSummaryText(slot)">（空）</div>
                    </div>
                    <div class="save-right">
                        <button class="smallbtn" @click="$store.game.manualSave(slot)"
                            :disabled="$store.game.disabled || !$store.game.started" disabled="disabled">
                            保存
                        </button>

                        <button class="smallbtn ghost" @click="$store.game.manualLoad(slot)"
                            :disabled="$store.game.disabled">
                            读取
                        </button>
                    </div>
                </div>
                <div class="save-slot">
                    <div class="save-left">
                        <div class="save-name">存档位 <span x-text="slot">2</span></div>
                        <div class="save-meta" x-text="$store.game.saveSummaryText(slot)">（空）</div>
                    </div>
                    <div class="save-right">
                        <button class="smallbtn" @click="$store.game.manualSave(slot)"
                            :disabled="$store.game.disabled || !$store.game.started" disabled="disabled">
                            保存
                        </button>

                        <button class="smallbtn ghost" @click="$store.game.manualLoad(slot)"
                            :disabled="$store.game.disabled">
                            读取
                        </button>
                    </div>
                </div>
                <div class="save-slot">
                    <div class="save-left">
                        <div class="save-name">存档位 <span x-text="slot">3</span></div>
                        <div class="save-meta" x-text="$store.game.saveSummaryText(slot)">（空）</div>
                    </div>
                    <div class="save-right">
                        <button class="smallbtn" @click="$store.game.manualSave(slot)"
                            :disabled="$store.game.disabled || !$store.game.started" disabled="disabled">
                            保存
                        </button>

                        <button class="smallbtn ghost" @click="$store.game.manualLoad(slot)"
                            :disabled="$store.game.disabled">
                            读取
                        </button>
                    </div>
                </div>

                <div class="tiny muted" style="padding: 0 14px 14px;">
                    - "保存"=保存当前状态 + 最近对话上下文<br>
                    - "读取"=恢复状态 + 恢复上下文，并以新会话继续
                </div>
            </div>
        </div>
    </div>

    <script src="game.js"></script>
    <script defer="" src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

</body>

</html>