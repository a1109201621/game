<html lang="zh-CN">

<head>
    <base href="https://www.dzmm.ai/api/gamefy/static/b2e4eb8e-68f9-43e7-b46c-f1728fab057b/">
    <script>(function () {
            'use strict';
            function l(r) {
                if (r == null || typeof r != 'object') return r;
                try {
                    return JSON.parse(JSON.stringify(r));
                } catch {
                    return r;
                }
            }
            var o = class {
                constructor(e, s = window) {
                    this.targetWindow = e;
                    this.sourceWindow = s;
                    this.listeners = new Map();
                    this.streamListeners = new Map();
                    this.messageHandler = null;
                }
                start(e) {
                    this.messageHandler ||
                        ((this.messageHandler = async (s) => {
                            if (s.source !== this.targetWindow) return;
                            let t = s.data;
                            if (t.type === 'dzmm:response') {
                                let n = this.listeners.get(t.id);
                                n &&
                                    (this.listeners.delete(t.id),
                                        t.error ? n(Promise.reject(new Error(t.error))) : n(t.result));
                            } else if (t.type === 'dzmm:stream') {
                                let n = this.streamListeners.get(t.id);
                                n && (n(t.content, t.done), t.done && this.streamListeners.delete(t.id));
                            } else t.type === 'dzmm:request' && e && (await e(t));
                        }),
                            this.sourceWindow.addEventListener('message', this.messageHandler));
                }
                stop() {
                    this.messageHandler &&
                        (this.sourceWindow.removeEventListener('message', this.messageHandler),
                            (this.messageHandler = null)),
                        this.listeners.clear(),
                        this.streamListeners.clear();
                }
                send(e) {
                    this.targetWindow.postMessage(e, '*');
                }
                request(e, s = {}) {
                    let t = `${Date.now()}-${Math.random().toString(36).slice(2)}`;
                    return new Promise((n, i) => {
                        this.listeners.set(t, (a) => {
                            a instanceof Promise ? a.catch(i) : n(a);
                        }),
                            this.send({ type: 'dzmm:request', id: t, method: e, params: l(s) });
                    });
                }
                requestWithStream(e, s, t) {
                    let n = `${Date.now()}-${Math.random().toString(36).slice(2)}`,
                        i = `${n}-stream`;
                    return (
                        this.streamListeners.set(i, t),
                        new Promise((a, c) => {
                            this.listeners.set(n, (m) => {
                                m instanceof Promise ? m.catch(c) : a(m);
                            }),
                                this.send({
                                    type: 'dzmm:request',
                                    id: n,
                                    method: e,
                                    params: l({ ...s, _streamId: i }),
                                });
                        })
                    );
                }
                respond(e, s, t) {
                    this.send({ type: 'dzmm:response', id: e, result: s, error: t });
                }
                streamUpdate(e, s, t) {
                    this.send({ type: 'dzmm:stream', id: e, content: s, done: t });
                }
            };
            var d = class {
                constructor(e = window.parent) {
                    this.kv = {
                        get: (e) => this.channel.request('kv.get', { key: e }),
                        put: (e, s) => this.channel.request('kv.put', { key: e, value: s }),
                        delete: (e) => this.channel.request('kv.delete', { key: e }),
                    };
                    this.draw = { generate: (e) => this.channel.request('draw.generate', e) };
                    this.chat = {
                        list: (e) => this.channel.request('chat.list', { ids: e }),
                        insert: (e, s) => this.channel.request('chat.insert', { parentId: e, messages: s }),
                        timeline: (e) => this.channel.request('chat.timeline', { hasId: e }),
                    };
                    if (typeof window > 'u') throw new Error('GamefyBrowserSDK requires a browser environment');
                    (this.channel = new o(e, window)),
                        this.channel.start(),
                        e !== window &&
                        (e.postMessage('iframe:content-ready', '*'),
                            window.addEventListener('message', (s) => {
                                s.data?.type === 'dzmm:parent-ready' && e.postMessage('iframe:content-ready', '*');
                            }));
                }
                async completions(e, s) {
                    let t = `${Date.now()}-${Math.random().toString(36).slice(2)}`;
                    await this.channel.requestWithStream('completions', { ...e, _streamId: t }, (n, i) =>
                        s?.(n, i, t),
                    );
                }
            };
            if (typeof window < 'u')
                try {
                    let r = new d();
                    window.dzmm = r;
                } catch (r) {
                    console.error('[Gamefy SDK] Initialization failed:', r);
                }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>末世寝取生存</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-card: #1e1e2a;
            --text-primary: #e8e8f0;
            --text-secondary: #a0a0b0;
            --text-muted: #606075;
            --accent-pink: #ff6b9d;
            --accent-purple: #9d6bff;
            --accent-blue: #6b9dff;
            --accent-cyan: #6bffd8;
            --accent-gold: #ffd86b;
            --accent-red: #ff6b6b;
            --accent-green: #6bff9d;
            --accent-orange: #ffaa6b;
            --border-color: #2a2a3a;
            --gradient-pink: linear-gradient(135deg, #ff6b9d, #ff9dbb);
            --gradient-purple: linear-gradient(135deg, #9d6bff, #bb9dff);
            --gradient-gold: linear-gradient(135deg, #ffd86b, #ffeb9d);
            --gradient-danger: linear-gradient(135deg, #ff6b6b, #ff9d9d);
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* ==================== 启动界面 ==================== */
        .start-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 30px 20px;
            background:
                radial-gradient(ellipse at top, rgba(157, 107, 255, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom, rgba(255, 107, 157, 0.1) 0%, transparent 50%),
                var(--bg-primary);
            overflow-y: auto;
        }

        .title-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--gradient-pink);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(255, 107, 157, 0.5);
            margin-bottom: 8px;
        }

        .game-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            letter-spacing: 3px;
        }

        .start-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .panel-title {
            font-size: 1.1rem;
            color: var(--accent-pink);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-pink);
            box-shadow: 0 0 10px rgba(255, 107, 157, 0.2);
        }

        .form-select {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23a0a0b0' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--accent-pink);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-textarea {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: vertical;
            min-height: 60px;
            transition: all 0.3s ease;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--accent-pink);
        }

        .character-setup {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 18px;
        }

        .character-setup-title {
            font-size: 0.95rem;
            color: var(--accent-purple);
            margin-bottom: 12px;
        }

        /* 性格词条选择 */
        .personality-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .personality-tag {
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .personality-tag:hover {
            border-color: var(--accent-pink);
            color: var(--accent-pink);
        }

        .personality-tag.selected {
            background: var(--accent-pink);
            border-color: var(--accent-pink);
            color: white;
        }

        .personality-desc-container {
            margin-top: 10px;
            display: none;
        }

        .personality-desc-container.active {
            display: block;
        }

        .personality-desc-item {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .personality-desc-label {
            font-size: 0.8rem;
            color: var(--accent-cyan);
            margin-bottom: 5px;
        }

        .personality-desc-input {
            width: 100%;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .personality-desc-input:focus {
            outline: none;
            border-color: var(--accent-pink);
        }

        /* 处女设置 */
        .virgin-options {
            display: none;
            margin-top: 10px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .virgin-options.active {
            display: block;
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .radio-option:hover {
            border-color: var(--accent-pink);
        }

        .radio-option.selected {
            border-color: var(--accent-pink);
            background: rgba(255, 107, 157, 0.1);
        }

        .radio-option input {
            display: none;
        }

        .radio-option span {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .radio-option.selected span {
            color: var(--accent-pink);
        }

        .custom-virgin-input {
            display: none;
            margin-top: 10px;
        }

        .custom-virgin-input.active {
            display: block;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient-pink);
            color: white;
            width: 100%;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 157, 0.5);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
            border-color: var(--accent-pink);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
        }

        /* ==================== 游戏主界面 ==================== */
        .game-screen {
            display: none;
            min-height: 100vh;
        }

        .game-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 20px;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title {
            font-size: 1.1rem;
            font-weight: 700;
            background: var(--gradient-pink);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-stats {
            display: flex;
            gap: 12px;
            font-size: 0.8rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
        }

        .stat-value {
            color: var(--accent-gold);
            font-weight: 600;
        }

        .header-right {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            padding: 7px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: var(--bg-card);
            border-color: var(--accent-pink);
        }

        .header-btn.active {
            background: var(--accent-pink);
            border-color: var(--accent-pink);
        }

        /* Debug按钮特殊样式 */
        .header-btn.debug-btn {
            border-color: var(--accent-orange);
            color: var(--accent-orange);
        }

        .header-btn.debug-btn:hover {
            background: var(--accent-orange);
            color: var(--bg-primary);
        }

        .header-btn.debug-btn.has-errors {
            animation: pulse-error 1s infinite;
        }

        @keyframes pulse-error {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(255, 107, 107, 0);
            }
        }

        .game-main {
            display: flex;
            padding-top: 55px;
            min-height: 100vh;
        }

        /* ==================== 左侧状态面板 ==================== */
        .side-panel {
            width: 310px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            height: calc(100vh - 55px);
            position: fixed;
            left: 0;
            top: 55px;
            overflow-y: auto;
            padding: 12px;
            transition: transform 0.3s ease;
            z-index: 50;
        }

        .side-panel.collapsed {
            transform: translateX(-100%);
        }

        .panel-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 8px;
        }

        .panel-tab {
            flex: 1;
            padding: 8px 5px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .panel-tab.active {
            background: var(--accent-pink);
            color: white;
        }

        .panel-tab:hover:not(.active) {
            background: var(--bg-card);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .status-section {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }

        .status-section-title {
            font-size: 0.8rem;
            color: var(--accent-cyan);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 0.78rem;
        }

        .status-label {
            color: var(--text-secondary);
        }

        .status-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .status-value.gold {
            color: var(--accent-gold);
        }

        .status-value.pink {
            color: var(--accent-pink);
        }

        .status-value.purple {
            color: var(--accent-purple);
        }

        .status-value.red {
            color: var(--accent-red);
        }

        .status-value.green {
            color: var(--accent-green);
        }

        .status-value.cyan {
            color: var(--accent-cyan);
        }

        .status-value.orange {
            color: var(--accent-orange);
        }

        .character-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 10px;
            margin-top: 8px;
        }

        .character-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .character-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--accent-pink);
        }

        .character-relation {
            font-size: 0.65rem;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .corruption-bar {
            height: 5px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
            margin: 6px 0;
        }

        .corruption-fill {
            height: 100%;
            background: var(--gradient-pink);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .star-rating {
            color: var(--accent-gold);
            font-size: 0.8rem;
            letter-spacing: 1px;
        }

        /* 任务卡片 */
        .task-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 3px solid var(--accent-purple);
        }

        .task-card.bounty {
            border-left-color: var(--accent-gold);
        }

        .task-card.completed {
            border-left-color: var(--accent-green);
            opacity: 0.7;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .task-type {
            font-size: 0.7rem;
            color: var(--accent-purple);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .task-card.bounty .task-type {
            color: var(--accent-gold);
        }

        .task-level {
            font-size: 0.65rem;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .task-content {
            font-size: 0.82rem;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .task-rewards {
            display: flex;
            gap: 12px;
            font-size: 0.72rem;
            margin-bottom: 8px;
        }

        .task-reward {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .task-reward.coins {
            color: var(--accent-gold);
        }

        .task-reward.exp {
            color: var(--accent-cyan);
        }

        .task-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.68rem;
        }

        .task-status.pending {
            background: rgba(157, 107, 255, 0.2);
            color: var(--accent-purple);
        }

        .task-status.completed {
            background: rgba(107, 255, 157, 0.2);
            color: var(--accent-green);
        }

        .task-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .task-btn {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 5px;
            font-size: 0.72rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .task-btn.refresh {
            background: var(--bg-card);
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .task-btn.refresh:hover:not(:disabled) {
            background: var(--accent-cyan);
            color: var(--bg-primary);
        }

        .task-btn.refresh:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .task-btn.complete {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .task-btn.complete:hover {
            opacity: 0.9;
        }

        .sex-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            font-size: 0.72rem;
        }

        .sex-stat {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }

        .inventory-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .inventory-item {
            background: var(--bg-secondary);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.72rem;
            color: var(--text-secondary);
        }

        .ability-card {
            background: var(--bg-secondary);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 6px;
            border: 1px solid var(--border-color);
        }

        .ability-name {
            font-size: 0.8rem;
            color: var(--accent-cyan);
            margin-bottom: 3px;
        }

        .ability-desc {
            font-size: 0.72rem;
            color: var(--text-secondary);
        }

        /* ==================== 对话区域 ==================== */
        .chat-container {
            flex: 1;
            margin-left: 310px;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 55px);
            background: var(--bg-primary);
            transition: margin-left 0.3s ease;
        }

        .chat-container.expanded {
            margin-left: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 85%;
            animation: fadeIn 0.3s ease;
            position: relative;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-bubble {
            padding: 12px 15px;
            border-radius: 14px;
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .message.user .message-bubble {
            background: var(--gradient-purple);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-bubble {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }

        .message-sender {
            font-size: 0.72rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            padding: 0 4px;
        }

        .message.user .message-sender {
            text-align: right;
        }

        /* 消息操作按钮 */
        .message-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            justify-content: flex-start;
        }

        .message.user .message-actions {
            justify-content: flex-end;
        }

        .message-action-btn {
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .message-action-btn:hover {
            background: var(--bg-card);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .message-action-btn.regenerate:hover {
            border-color: var(--accent-pink);
            color: var(--accent-pink);
        }

        .message-action-btn.edit:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* 总结消息特殊样式 */
        .message.summary .message-bubble {
            background: linear-gradient(135deg, rgba(107, 255, 216, 0.1), rgba(157, 107, 255, 0.1));
            border: 1px solid var(--accent-cyan);
        }

        .message.summary .message-sender {
            color: var(--accent-cyan);
        }

        .summary-badge {
            display: inline-block;
            background: var(--accent-cyan);
            color: var(--bg-primary);
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 600;
        }

        /* 编辑模式 */
        .message-edit-container {
            margin-top: 8px;
        }

        .message-edit-textarea {
            width: 100%;
            padding: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--accent-gold);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.85rem;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 8px;
        }

        .message-edit-textarea:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(255, 216, 107, 0.2);
        }

        .message-edit-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .message-edit-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            font-size: 0.78rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .message-edit-btn.save {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .message-edit-btn.cancel {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .message-edit-btn:hover {
            opacity: 0.85;
        }

        /* 输入区域 */
        .chat-input-container {
            padding: 12px 15px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }

        .input-wrapper {
            display: flex;
            gap: 8px;
            max-width: 900px;
            margin: 0 auto;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            resize: none;
            min-height: 45px;
            max-height: 120px;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-pink);
            box-shadow: 0 0 12px rgba(255, 107, 157, 0.2);
        }

        .send-btn {
            padding: 12px 20px;
            background: var(--gradient-pink);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 快捷操作 */
        .quick-actions {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 7px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            color: var(--text-secondary);
            font-size: 0.78rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-btn:hover {
            background: var(--bg-card);
            border-color: var(--accent-pink);
            color: var(--accent-pink);
        }

        .quick-btn.summary-btn {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .quick-btn.summary-btn:hover {
            background: var(--accent-cyan);
            color: var(--bg-primary);
        }

        /* ==================== 模态框 ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 22px;
            max-width: 550px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        /* Debug模态框特殊样式 - 更大 */
        .modal.debug-modal {
            max-width: 900px;
            max-height: 90vh;
        }

        /* 作弊模态框特殊样式 */
        .modal.cheat-modal {
            max-width: 700px;
            max-height: 90vh;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.1rem;
            color: var(--accent-pink);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.4rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--accent-red);
        }

        /* ==================== Debug面板样式 ==================== */
        .debug-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 15px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 8px;
        }

        .debug-tab {
            flex: 1;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.82rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .debug-tab.active {
            background: var(--accent-orange);
            color: white;
        }

        .debug-tab:hover:not(.active) {
            background: var(--bg-card);
        }

        .debug-tab .badge {
            background: var(--accent-red);
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .debug-tab.active .badge {
            background: white;
            color: var(--accent-orange);
        }

        .debug-content {
            display: none;
        }

        .debug-content.active {
            display: block;
        }

        .debug-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .debug-toolbar-btn {
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.78rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .debug-toolbar-btn:hover {
            background: var(--bg-card);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .debug-toolbar-btn.danger {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .debug-toolbar-btn.danger:hover {
            background: var(--accent-red);
            color: white;
        }

        .debug-log-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
        }

        .debug-log-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.8rem;
        }

        .debug-log-item:last-child {
            border-bottom: none;
        }

        .debug-log-item.error {
            background: rgba(255, 107, 107, 0.1);
            border-left: 3px solid var(--accent-red);
        }

        .debug-log-item.warning {
            background: rgba(255, 170, 107, 0.1);
            border-left: 3px solid var(--accent-orange);
        }

        .debug-log-item.info {
            background: rgba(107, 157, 255, 0.1);
            border-left: 3px solid var(--accent-blue);
        }

        .debug-log-item.success {
            background: rgba(107, 255, 157, 0.1);
            border-left: 3px solid var(--accent-green);
        }

        .debug-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .debug-log-type {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 1px;
        }

        .debug-log-type.error {
            color: var(--accent-red);
        }

        .debug-log-type.warning {
            color: var(--accent-orange);
        }

        .debug-log-type.info {
            color: var(--accent-blue);
        }

        .debug-log-type.success {
            color: var(--accent-green);
        }

        .debug-log-type.request {
            color: var(--accent-cyan);
        }

        .debug-log-type.response {
            color: var(--accent-purple);
        }

        .debug-log-time {
            color: var(--text-muted);
            font-size: 0.7rem;
        }

        .debug-log-source {
            color: var(--accent-cyan);
            font-size: 0.72rem;
            margin-bottom: 6px;
        }

        .debug-log-message {
            color: var(--text-primary);
            line-height: 1.5;
            word-break: break-all;
        }

        .debug-log-details {
            margin-top: 8px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.72rem;
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-log-toggle {
            background: none;
            border: none;
            color: var(--accent-cyan);
            font-size: 0.72rem;
            cursor: pointer;
            padding: 4px 8px;
            margin-top: 6px;
        }

        .debug-log-toggle:hover {
            text-decoration: underline;
        }

        .debug-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .debug-empty-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        /* AI交互记录特殊样式 */
        .ai-log-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .ai-log-item:last-child {
            border-bottom: none;
        }

        .ai-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .ai-log-title {
            font-weight: 600;
            color: var(--accent-cyan);
            font-size: 0.85rem;
        }

        .ai-log-meta {
            display: flex;
            gap: 12px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .ai-log-section {
            margin-bottom: 12px;
        }

        .ai-log-section-title {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ai-log-section-title::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .ai-log-section-title.request::before {
            background: var(--accent-cyan);
        }

        .ai-log-section-title.response::before {
            background: var(--accent-purple);
        }

        .ai-log-content {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 12px;
            font-size: 0.78rem;
            color: var(--text-primary);
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.5;
        }

        .ai-log-content.collapsed {
            max-height: 60px;
            overflow: hidden;
            position: relative;
        }

        .ai-log-content.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(transparent, var(--bg-tertiary));
        }

        .ai-log-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.68rem;
            font-weight: 600;
        }

        .ai-log-status.success {
            background: rgba(107, 255, 157, 0.2);
            color: var(--accent-green);
        }

        .ai-log-status.error {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-red);
        }

        .ai-log-status.pending {
            background: rgba(255, 216, 107, 0.2);
            color: var(--accent-gold);
        }

        /* 游戏状态显示 */
        .debug-state-section {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .debug-state-title {
            font-size: 0.82rem;
            color: var(--accent-purple);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .debug-state-content {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.72rem;
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }

        /* 商店搜索 */
        .shop-search-container {
            margin-bottom: 18px;
        }

        .shop-search-wrapper {
            display: flex;
            gap: 8px;
        }

        .shop-search-input {
            flex: 1;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .shop-search-input:focus {
            outline: none;
            border-color: var(--accent-pink);
        }

        .shop-search-btn {
            padding: 10px 16px;
            background: var(--gradient-pink);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .shop-search-btn:hover:not(:disabled) {
            transform: translateY(-1px);
        }

        .shop-search-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .shop-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .shop-results {
            display: grid;
            gap: 12px;
        }

        .shop-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px;
            transition: all 0.3s ease;
        }

        .shop-item:hover {
            border-color: var(--accent-pink);
            transform: translateY(-2px);
        }

        .shop-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .shop-item-name {
            font-size: 0.95rem;
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .shop-item-price {
            font-size: 0.9rem;
            color: var(--accent-gold);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .shop-item-desc {
            font-size: 0.82rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .shop-item-effect {
            font-size: 0.78rem;
            color: var(--accent-green);
            background: rgba(107, 255, 157, 0.1);
            padding: 6px 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .shop-item-btn {
            width: 100%;
            padding: 8px;
            background: var(--bg-card);
            border: 1px solid var(--accent-pink);
            border-radius: 6px;
            color: var(--accent-pink);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.82rem;
        }

        .shop-item-btn:hover:not(:disabled) {
            background: var(--accent-pink);
            color: white;
        }

        .shop-item-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: var(--text-muted);
            color: var(--text-muted);
        }

        .shop-loading {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
        }

        .shop-loading-spinner {
            width: 35px;
            height: 35px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .shop-empty {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
        }

        /* 商店历史记录样式 */
        .shop-history-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .shop-history-title {
            font-size: 0.85rem;
            color: var(--accent-purple);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .shop-history-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .shop-history-tag {
            padding: 5px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .shop-history-tag:hover {
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }

        /* 存档槽位 */
        .save-slots {
            display: grid;
            gap: 12px;
        }

        .save-slot {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px;
            transition: all 0.3s ease;
        }

        .save-slot:hover {
            border-color: var(--accent-cyan);
        }

        .save-slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .save-slot-name {
            font-size: 0.95rem;
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .save-slot-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .save-slot-info {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .save-slot-empty {
            color: var(--text-muted);
            font-style: italic;
        }

        .save-slot-actions {
            display: flex;
            gap: 8px;
        }

        .save-slot-btn {
            flex: 1;
            padding: 7px 10px;
            border-radius: 5px;
            font-size: 0.78rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .save-slot-btn.save {
            background: var(--accent-cyan);
            color: var(--bg-primary);
        }

        .save-slot-btn.load {
            background: var(--accent-purple);
            color: white;
        }

        .save-slot-btn.delete {
            background: var(--accent-red);
            color: white;
        }

        .save-slot-btn:hover {
            opacity: 0.85;
        }

        .save-slot-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* 加载动画 */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 15px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }

        .typing-dot {
            width: 7px;
            height: 7px;
            background: var(--accent-pink);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: 0.4;
            }

            30% {
                transform: translateY(-6px);
                opacity: 1;
            }
        }

        /* 通知 */
        .notification {
            position: fixed;
            top: 70px;
            right: 15px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.85rem;
            z-index: 200;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }

        .notification.success {
            border-left: 4px solid var(--accent-green);
        }

        .notification.error {
            border-left: 4px solid var(--accent-red);
        }

        .notification.info {
            border-left: 4px solid var(--accent-cyan);
        }

        .notification.warning {
            border-left: 4px solid var(--accent-orange);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ==================== 作弊面板样式 ==================== */
        .cheat-section {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }

        .cheat-section-title {
            font-size: 0.9rem;
            color: var(--accent-gold);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cheat-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 10px;
        }

        .cheat-row.three-col {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .cheat-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .cheat-label {
            font-size: 0.78rem;
            color: var(--text-secondary);
        }

        .cheat-input {
            padding: 8px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .cheat-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 8px rgba(255, 216, 107, 0.2);
        }

        .cheat-input[type="number"] {
            -moz-appearance: textfield;
        }

        .cheat-input[type="number"]::-webkit-outer-spin-button,
        .cheat-input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .cheat-select {
            padding: 8px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .cheat-select:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .cheat-btn-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .cheat-btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cheat-btn.apply {
            background: var(--gradient-gold);
            color: var(--bg-primary);
        }

        .cheat-btn.apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 216, 107, 0.4);
        }

        .cheat-btn.reset {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .cheat-btn.reset:hover {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .cheat-warning {
            background: rgba(255, 170, 107, 0.1);
            border: 1px solid var(--accent-orange);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 15px;
            font-size: 0.78rem;
            color: var(--accent-orange);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 设置模态框里的作弊按钮 */
        .settings-cheat-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ffd86b, #ffaa6b);
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .settings-cheat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 216, 107, 0.4);
        }

        /* ==================== 移动端切换按钮样式 ==================== */
        .toggle-panel-btn {
            display: none;
        }

        /* ==================== 响应式设计 - 修复移动端问题 ==================== */
        @media (max-width: 900px) {

            /* 移动端侧边栏 - 默认隐藏在左侧 */
            .side-panel {
                width: 100%;
                max-width: 350px;
                transform: translateX(-100%);
                box-shadow: 5px 0 20px rgba(0, 0, 0, 0.5);
            }

            /* 移动端侧边栏显示状态 */
            .side-panel.mobile-visible {
                transform: translateX(0);
            }

            /* 聊天区域在移动端始终全宽 */
            .chat-container {
                margin-left: 0;
            }

            /* 显示切换按钮 */
            .toggle-panel-btn {
                display: flex !important;
                align-items: center;
                justify-content: center;
                min-width: 40px;
                font-size: 1.1rem;
            }

            .game-title {
                font-size: 1.8rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .header-stats {
                display: none;
            }

            .header-right {
                gap: 4px;
            }

            .header-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            /* 隐藏部分按钮文字，只显示图标 */
            .header-btn.debug-btn {
                padding: 6px 8px;
            }

            .modal.debug-modal {
                max-width: 100%;
                margin: 10px;
                padding: 15px;
            }

            .modal.cheat-modal {
                max-width: 100%;
                margin: 10px;
                padding: 15px;
            }

            .debug-tabs {
                flex-wrap: wrap;
            }

            .debug-tab {
                flex: 1 1 45%;
                padding: 8px 6px;
                font-size: 0.75rem;
            }

            /* 移动端遮罩层 */
            .mobile-overlay {
                display: none;
                position: fixed;
                top: 55px;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.6);
                z-index: 40;
            }

            .mobile-overlay.active {
                display: block;
            }

            .cheat-row {
                grid-template-columns: 1fr;
            }

            .cheat-row.three-col {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* 任务生成加载 */
        .task-loading {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.82rem;
        }

        .task-loading-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body>

    <!-- ==================== 启动界面 ==================== -->
    <div class="start-screen" id="startScreen">
        <div class="title-container">
            <h1 class="game-title">末世寝取生存</h1>
            <p class="game-subtitle">❄️ POST-APOCALYPTIC FROZEN WORLD ❄️</p>
        </div>

        <div class="start-panel">
            <!-- AI模型选择 -->
            <h2 class="panel-title">⚙️ 系统设置</h2>
            <div class="form-group">
                <label class="form-label">选择AI模型</label>
                <select class="form-select" id="modelSelect">
                    <option value="nalang-xl-0826">Nalang XL (默认)</option>
                    <option value="nalang-medium-0826">Nalang Medium</option>
                    <option value="nalang-max-0826">Nalang Max</option>
                </select>
            </div>

            <!-- 主角设定 -->
            <div class="character-setup">
                <h3 class="character-setup-title">👤 主角设定</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">主角名称</label>
                        <input type="text" class="form-input" id="protagonistName" placeholder="输入主角名字">
                    </div>
                    <div class="form-group">
                        <label class="form-label">主角年龄</label>
                        <input type="number" class="form-input" id="protagonistAge" placeholder="输入年龄" min="18"
                            onblur="if(this.value &lt; 18) this.value = 18">
                    </div>
                </div>
            </div>

            <!-- 女主角设定 -->
            <div class="character-setup">
                <h3 class="character-setup-title">💕 女主角设定</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">女主角名称</label>
                        <input type="text" class="form-input" id="heroineName" placeholder="输入女主角名字">
                    </div>
                    <div class="form-group">
                        <label class="form-label">女主角年龄</label>
                        <input type="number" class="form-input" id="heroineAge" placeholder="输入年龄" min="18"
                            onblur="if(this.value &lt; 18) this.value = 18">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">与主角关系</label>
                        <input type="text" class="form-input" id="heroineRelation" placeholder="如：女友、青梅竹马、妹妹">
                    </div>
                    <div class="form-group">
                        <label class="form-label">女主角身份</label>
                        <input type="text" class="form-input" id="heroineIdentity" placeholder="如：大学校花、清纯学生">
                    </div>
                </div>

                <!-- 处女设定 -->
                <div class="form-group">
                    <label class="form-label">处女状态</label>
                    <select class="form-select" id="virginSelect" onchange="handleVirginChange()">
                        <option value="yes">是处女（完璧）</option>
                        <option value="no">非处女</option>
                    </select>
                </div>

                <div class="virgin-options" id="virginOptions">
                    <label class="form-label" style="margin-bottom: 8px;">初夜被谁夺走？</label>
                    <div class="radio-group" id="virginRadioGroup">
                        <label class="radio-option" onclick="selectVirginOption(this, 'protagonist')">
                            <input type="radio" name="virginTaker" value="protagonist">
                            <span>主角</span>
                        </label>
                        <label class="radio-option" onclick="selectVirginOption(this, 'other')">
                            <input type="radio" name="virginTaker" value="other">
                            <span>其他人</span>
                        </label>
                        <label class="radio-option" onclick="selectVirginOption(this, 'custom')">
                            <input type="radio" name="virginTaker" value="custom">
                            <span>自定义</span>
                        </label>
                    </div>
                    <div class="custom-virgin-input" id="customVirginInput">
                        <input type="text" class="form-input" id="customVirginText" placeholder="输入夺走初夜的对象描述...">
                    </div>
                </div>

                <!-- 性格词条 -->
                <div class="form-group">
                    <label class="form-label">性格词条（可多选）</label>
                    <div class="personality-tags" id="personalityTags">
                        <div class="personality-tag" data-id="pure" onclick="togglePersonalityTag('pure')">
                            清纯
                        </div>

                        <div class="personality-tag" data-id="shy" onclick="togglePersonalityTag('shy')">
                            害羞
                        </div>

                        <div class="personality-tag" data-id="gentle" onclick="togglePersonalityTag('gentle')">
                            温柔
                        </div>

                        <div class="personality-tag" data-id="tsundere" onclick="togglePersonalityTag('tsundere')">
                            傲娇
                        </div>

                        <div class="personality-tag" data-id="cold" onclick="togglePersonalityTag('cold')">
                            高冷
                        </div>

                        <div class="personality-tag" data-id="cheerful" onclick="togglePersonalityTag('cheerful')">
                            开朗
                        </div>

                        <div class="personality-tag" data-id="obedient" onclick="togglePersonalityTag('obedient')">
                            顺从
                        </div>

                        <div class="personality-tag" data-id="proud" onclick="togglePersonalityTag('proud')">
                            高傲
                        </div>

                        <div class="personality-tag" data-id="innocent" onclick="togglePersonalityTag('innocent')">
                            天然
                        </div>

                        <div class="personality-tag" data-id="sensual" onclick="togglePersonalityTag('sensual')">
                            闷骚
                        </div>

                        <div class="personality-tag" data-id="passionate" onclick="togglePersonalityTag('passionate')">
                            热情
                        </div>

                        <div class="personality-tag" data-id="devoted" onclick="togglePersonalityTag('devoted')">
                            专一
                        </div>

                        <div class="personality-tag" data-id="sensitive" onclick="togglePersonalityTag('sensitive')">
                            敏感
                        </div>

                        <div class="personality-tag" data-id="masochist" onclick="togglePersonalityTag('masochist')">
                            抖M
                        </div>

                        <div class="personality-tag" data-id="exhibitionist"
                            onclick="togglePersonalityTag('exhibitionist')">
                            暴露癖
                        </div>
                    </div>
                    <div class="personality-desc-container" id="personalityDescContainer">
                        <!-- 动态生成选中词条的描述输入框 -->
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" id="startGameBtn" onclick="startGame()">
                🎮 开始游戏
            </button>
        </div>
    </div>

    <!-- ==================== 游戏主界面 ==================== -->
    <div class="game-screen" id="gameScreen">
        <!-- 顶部导航 -->
        <header class="game-header">
            <div class="header-left">
                <button class="header-btn toggle-panel-btn" id="togglePanelBtn" onclick="toggleSidePanel()">📊</button>
                <div class="header-stats">
                    <div class="stat-item">
                        <span>💰</span>
                        <span class="stat-value" id="headerCoins">0</span>
                    </div>
                    <div class="stat-item">
                        <span>📈</span>
                        <span class="stat-value" id="headerLevel">Lv.1</span>
                    </div>
                    <div class="stat-item">
                        <span>🕐</span>
                        <span class="stat-value" id="headerTime">14:30</span>
                    </div>
                    <div class="stat-item">
                        <span>⭐</span>
                        <span class="stat-value" id="headerCorruption">1</span>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="header-btn" onclick="openShop()">🛒 商店</button>
                <button class="header-btn" onclick="openSaveModal()">💾 存档</button>
                <button class="header-btn" onclick="openModelModal()">⚙️ 设置</button>
            </div>
        </header>

        <div class="game-main">
            <!-- 移动端遮罩层 -->
            <div class="mobile-overlay" id="mobileOverlay" onclick="closeSidePanel()"></div>

            <!-- 左侧状态面板 -->
            <aside class="side-panel" id="sidePanel">
                <!-- 面板标签切换 -->
                <div class="panel-tabs">
                    <button class="panel-tab active" data-tab="status" onclick="switchTab('status')">📊 状态</button>
                    <button class="panel-tab" data-tab="tasks" onclick="switchTab('tasks')">📋 任务</button>
                    <button class="panel-tab" data-tab="character" onclick="switchTab('character')">💕 角色</button>
                </div>

                <!-- 状态标签页 -->
                <div class="tab-content active" id="tab-status">
                    <div class="status-section">
                        <div class="status-section-title">🌍 全局状态</div>
                        <div class="status-row">
                            <span class="status-label">游戏时间</span>
                            <span class="status-value" id="gameTime">2025-12-15 14:30</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">星期</span>
                            <span class="status-value" id="gameWeekday">星期一</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">当前位置</span>
                            <span class="status-value cyan" id="gameLocation">避难所</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">室外温度</span>
                            <span class="status-value red" id="outdoorTemp">-35°C</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">室内温度</span>
                            <span class="status-value green" id="indoorTemp">18°C</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">天气状况</span>
                            <span class="status-value" id="weather">阴冷</span>
                        </div>
                    </div>

                    <div class="status-section">
                        <div class="status-section-title">💎 系统核心</div>
                        <div class="status-row">
                            <span class="status-label">寝取等级</span>
                            <span class="status-value purple" id="systemLevel">Lv.1</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">经验值</span>
                            <span class="status-value cyan" id="systemExp">0 / 100</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">寝取币</span>
                            <span class="status-value gold" id="systemCoins">0 💰</span>
                        </div>
                    </div>

                    <div class="status-section">
                        <div class="status-section-title">🏠 避难所</div>
                        <div class="status-row">
                            <span class="status-label">等级</span>
                            <span class="status-value" id="shelterLevel">Lv.1 末世之光</span>
                        </div>
                        <div style="margin-top: 8px;">
                            <span class="status-label">物资储备</span>
                            <div class="inventory-list" id="inventoryList"></div>
                        </div>
                    </div>

                    <div class="status-section">
                        <div class="status-section-title">⚡ 主角能力</div>
                        <div id="abilitiesList">
                            <div style="color: var(--text-muted); font-size: 0.75rem;">暂无特殊能力</div>
                        </div>
                    </div>
                </div>

                <!-- 任务标签页 -->
                <div class="tab-content" id="tab-tasks">
                    <div class="status-section">
                        <div class="status-section-title">📋 每日任务</div>
                        <div id="dailyTaskContainer"></div>
                    </div>

                    <div class="status-section">
                        <div class="status-section-title">🎯 悬赏任务</div>
                        <div id="bountyTaskContainer">
                            <div style="color: var(--text-muted); font-size: 0.75rem;">悬赏任务仅在周一/周四开放</div>
                        </div>
                    </div>

                    <div class="status-section">
                        <div class="status-section-title">✅ 已完成任务</div>
                        <div id="completedTasksContainer">
                            <div style="color: var(--text-muted); font-size: 0.75rem;">暂无完成记录</div>
                        </div>
                    </div>
                </div>

                <!-- 角色标签页 -->
                <div class="tab-content" id="tab-character">
                    <div class="status-section">
                        <div class="status-section-title">💕 女主角详情</div>
                        <div class="character-card">
                            <div class="character-header">
                                <span class="character-name" id="heroineDisplayName">林雨晴</span>
                                <span class="character-relation" id="heroineDisplayRelation">女友</span>
                            </div>
                            <div class="status-row">
                                <span class="status-label">年龄</span>
                                <span class="status-value" id="heroineDisplayAge">21岁</span>
                            </div>
                            <div class="status-row">
                                <span class="status-label">身份</span>
                                <span class="status-value" id="heroineDisplayIdentity">大学校花</span>
                            </div>
                            <div class="status-row">
                                <span class="status-label">性格</span>
                                <span class="status-value cyan" id="heroineDisplayPersonality">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="status-section">
                        <div class="status-section-title">💔 堕落数据</div>
                        <div class="status-row">
                            <span class="status-label">淫乱等级</span>
                            <span class="star-rating" id="corruptionStars">⭐☆☆☆☆</span>
                        </div>
                        <div class="corruption-bar">
                            <div class="corruption-fill" id="corruptionBar" style="width: 5%;"></div>
                        </div>
                        <div class="status-row">
                            <span class="status-label">出轨值</span>
                            <span class="status-value pink" id="infidelityValue">0%</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">处女状态</span>
                            <span class="status-value" id="virginStatus">完璧</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">出轨对象数</span>
                            <span class="status-value red" id="cheatingCount">0</span>
                        </div>
                    </div>

                    <div class="status-section">
                        <div class="status-section-title">📊 性经验统计</div>
                        <div class="sex-stats-grid" id="sexStatsGrid"></div>
                    </div>
                </div>
            </aside>

            <!-- 对话区域 -->
            <main class="chat-container" id="chatContainer">
                <div class="chat-messages" id="chatMessages"></div>

                <div class="chat-input-container">
                    <div class="quick-actions" id="quickActions">
                        <button class="quick-btn" onclick="quickAction('让女友去执行当前任务')">🎯 执行任务</button>
                        <button class="quick-btn" onclick="advanceTime(1)">⏰ 时间+1h</button>
                        <button class="quick-btn" onclick="advanceTime(24)">📅 时间+1天</button>
                        <button class="quick-btn" onclick="advanceTime(168)">📆 时间+7天</button>
                        <button class="quick-btn summary-btn" onclick="prepareSummary()">📝 总结</button>
                    </div>
                    <div class="input-wrapper">
                        <textarea class="chat-input" id="userInput" placeholder="输入你的行动或对话..." rows="1"></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            发送 ➤
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ==================== 商店模态框 ==================== -->
    <div class="modal-overlay" id="shopModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">🛒 系统商店</h3>
                <button class="modal-close" onclick="closeShop()">×</button>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">当前寝取币:</span>
                <span id="shopCoins" style="color: var(--accent-gold); font-size: 1.1rem; font-weight: 600;">0 💰</span>
            </div>

            <div class="shop-search-container">
                <div class="shop-search-wrapper">
                    <input type="text" class="shop-search-input" id="shopSearchInput" placeholder="输入你想要的物品或能力..."
                        onkeydown="if(event.key==='Enter')searchShop()">
                    <button class="shop-search-btn" id="shopSearchBtn" onclick="searchShop()">🔍 搜索</button>
                </div>
                <p class="shop-hint">💡 例如："增强性能力"、"让女友更敏感的道具"、"监控录像设备"</p>
            </div>

            <!-- 搜索历史 -->
            <div class="shop-history-container" id="shopHistoryContainer" style="display: none;">
                <div class="shop-history-title">📜 搜索历史（点击快速搜索）</div>
                <div class="shop-history-tags" id="shopHistoryTags"></div>
            </div>

            <div class="shop-results" id="shopResults">
                <div class="shop-empty">
                    <p>🛍️ 输入关键词搜索商品</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== 存档模态框 ==================== -->
    <div class="modal-overlay" id="saveModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">💾 存档管理</h3>
                <button class="modal-close" onclick="closeSaveModal()">×</button>
            </div>

            <div class="save-slots" id="saveSlots">
                <!-- 动态生成存档槽位 -->
            </div>
        </div>
    </div>

    <!-- ==================== 模型/设置模态框 ==================== -->
    <div class="modal-overlay" id="modelModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">⚙️ 游戏设置</h3>
                <button class="modal-close" onclick="closeModelModal()">×</button>
            </div>
            <div class="form-group">
                <label class="form-label">选择AI模型</label>
                <select class="form-select" id="inGameModelSelect">
                    <option value="nalang-xl-0826">Nalang XL (默认)</option>
                    <option value="nalang-medium-0826">Nalang Medium</option>
                    <option value="nalang-max-0826">Nalang Max</option>
                </select>
            </div>
            <p style="color: var(--text-muted); font-size: 0.82rem; margin: 12px 0;">
                当前: <span id="currentModelDisplay" style="color: var(--accent-cyan);">nalang-xl-0826</span>
            </p>
            <button class="btn btn-primary" onclick="applyModel()">确认切换模型</button>

            <!-- 作弊按钮 -->
            <button class="settings-cheat-btn" onclick="openCheatModal()">
                🎮 作弊模式
            </button>
        </div>
    </div>

    <!-- ==================== 作弊模态框 ==================== -->
    <div class="modal-overlay" id="cheatModal">
        <div class="modal cheat-modal">
            <div class="modal-header">
                <h3 class="modal-title">🎮 作弊模式</h3>
                <button class="modal-close" onclick="closeCheatModal()">×</button>
            </div>

            <div class="cheat-warning">
                ⚠️ 警告：修改数值可能会影响游戏体验，请谨慎使用！
            </div>

            <!-- 系统数值 -->
            <div class="cheat-section">
                <div class="cheat-section-title">💎 系统数值</div>
                <div class="cheat-row three-col">
                    <div class="cheat-item">
                        <label class="cheat-label">寝取币</label>
                        <input type="number" class="cheat-input" id="cheatCoins" min="0">
                    </div>
                    <div class="cheat-item">
                        <label class="cheat-label">经验值</label>
                        <input type="number" class="cheat-input" id="cheatExp" min="0">
                    </div>
                    <div class="cheat-item">
                        <label class="cheat-label">等级</label>
                        <input type="number" class="cheat-input" id="cheatLevel" min="1" max="99">
                    </div>
                </div>
            </div>

            <!-- 女主角数值 -->
            <div class="cheat-section">
                <div class="cheat-section-title">💕 女主角数值</div>
                <div class="cheat-row">
                    <div class="cheat-item">
                        <label class="cheat-label">淫乱等级 (1-5星)</label>
                        <input type="number" class="cheat-input" id="cheatCorruptionLevel" min="1" max="5">
                    </div>
                    <div class="cheat-item">
                        <label class="cheat-label">淫乱经验 (0-100)</label>
                        <input type="number" class="cheat-input" id="cheatCorruptionExp" min="0" max="100">
                    </div>
                </div>
                <div class="cheat-row">
                    <div class="cheat-item">
                        <label class="cheat-label">出轨值 (0-100%)</label>
                        <input type="number" class="cheat-input" id="cheatInfidelity" min="0" max="100">
                    </div>
                    <div class="cheat-item">
                        <label class="cheat-label">出轨对象数</label>
                        <input type="number" class="cheat-input" id="cheatCheatingCount" min="0">
                    </div>
                </div>
                <div class="cheat-row">
                    <div class="cheat-item">
                        <label class="cheat-label">处女状态</label>
                        <input type="text" class="cheat-input" id="cheatVirginStatus" placeholder="如：完璧、被某人夺走">
                    </div>
                </div>
            </div>

            <!-- 性经验统计 -->
            <div class="cheat-section">
                <div class="cheat-section-title">📊 性经验统计</div>
                <div class="cheat-row three-col">
                    <div class="cheat-item">
                        <label class="cheat-label">口部侍奉</label>
                        <input type="number" class="cheat-input" id="cheatOral" min="0">
                    </div>
                    <div class="cheat-item">
                        <label class="cheat-label">手部侍奉</label>
                        <input type="number" class="cheat-input" id="cheatHandjob" min="0">
                    </div>
                    <div class="cheat-item">
                        <label class="cheat-label">乳部侍奉</label>
                        <input type="number" class="cheat-input" id="cheatBoobjob" min="0">
                    </div>
                </div>
                <div class="cheat-row three-col">
                    <div class="cheat-item">
                        <label class="cheat-label">足部侍奉</label>
                        <input type="number" class="cheat-input" id="cheatFootjob" min="0">
                    </div>
                    <div class="cheat-item">
                        <label class="cheat-label">肛门性交</label>
                        <input type="number" class="cheat-input" id="cheatAnal" min="0">
                    </div>
                    <div class="cheat-item">
                        <label class="cheat-label">戴套性交</label>
                        <input type="number" class="cheat-input" id="cheatCondomSex" min="0">
                    </div>
                </div>
                <div class="cheat-row three-col">
                    <div class="cheat-item">
                        <label class="cheat-label">无套内射</label>
                        <input type="number" class="cheat-input" id="cheatCreampie" min="0">
                    </div>
                    <div class="cheat-item">
                        <label class="cheat-label">体外射精</label>
                        <input type="number" class="cheat-input" id="cheatExternalCum" min="0">
                    </div>
                    <div class="cheat-item">
                        <label class="cheat-label">3P/乱交</label>
                        <input type="number" class="cheat-input" id="cheatThreesome" min="0">
                    </div>
                </div>
                <div class="cheat-row three-col">
                    <div class="cheat-item">
                        <label class="cheat-label">素股</label>
                        <input type="number" class="cheat-input" id="cheatIntercrural" min="0">
                    </div>
                    <div class="cheat-item">
                        <label class="cheat-label">高潮次数</label>
                        <input type="number" class="cheat-input" id="cheatOrgasms" min="0">
                    </div>
                    <div class="cheat-item">
                        <label class="cheat-label">榨精(ml)</label>
                        <input type="number" class="cheat-input" id="cheatCumExtracted" min="0">
                    </div>
                </div>
            </div>

            <!-- 环境设置 -->
            <div class="cheat-section">
                <div class="cheat-section-title">🌍 环境设置</div>
                <div class="cheat-row">
                    <div class="cheat-item">
                        <label class="cheat-label">室外温度 (°C)</label>
                        <input type="number" class="cheat-input" id="cheatOutdoorTemp">
                    </div>
                    <div class="cheat-item">
                        <label class="cheat-label">室内温度 (°C)</label>
                        <input type="number" class="cheat-input" id="cheatIndoorTemp">
                    </div>
                </div>
                <div class="cheat-row">
                    <div class="cheat-item">
                        <label class="cheat-label">当前位置</label>
                        <input type="text" class="cheat-input" id="cheatLocation" placeholder="如：避难所、商业区">
                    </div>
                    <div class="cheat-item">
                        <label class="cheat-label">天气状况</label>
                        <input type="text" class="cheat-input" id="cheatWeather" placeholder="如：阴冷、暴风雪">
                    </div>
                </div>
            </div>

            <!-- 避难所设置 -->
            <div class="cheat-section">
                <div class="cheat-section-title">🏠 避难所设置</div>
                <div class="cheat-row">
                    <div class="cheat-item">
                        <label class="cheat-label">避难所等级</label>
                        <input type="number" class="cheat-input" id="cheatShelterLevel" min="1" max="10">
                    </div>
                    <div class="cheat-item">
                        <label class="cheat-label">避难所名称</label>
                        <input type="text" class="cheat-input" id="cheatShelterName" placeholder="如：末世之光">
                    </div>
                </div>
            </div>

            <!-- 按钮 -->
            <div class="cheat-btn-row">
                <button class="cheat-btn reset" onclick="loadCheatValues()">🔄 重置为当前值</button>
                <button class="cheat-btn apply" onclick="applyCheat()">✅ 应用修改</button>
            </div>
        </div>
    </div>

    <!-- ==================== Debug调试模态框 ==================== -->
    <div class="modal-overlay" id="debugModal">
        <div class="modal debug-modal">
            <div class="modal-header">
                <h3 class="modal-title">🐛 Debug 调试面板</h3>
                <button class="modal-close" onclick="closeDebugModal()">×</button>
            </div>

            <!-- Debug标签页切换 -->
            <div class="debug-tabs">
                <button class="debug-tab active" data-debug-tab="errors" onclick="switchDebugTab('errors')">
                    ❌ 错误日志
                    <span class="badge" id="errorCountBadge">0</span>
                </button>
                <button class="debug-tab" data-debug-tab="ai" onclick="switchDebugTab('ai')">
                    🤖 AI交互
                    <span class="badge" id="aiCountBadge">0</span>
                </button>
                <button class="debug-tab" data-debug-tab="state" onclick="switchDebugTab('state')">
                    📊 游戏状态
                </button>
                <button class="debug-tab" data-debug-tab="all" onclick="switchDebugTab('all')">
                    📋 全部日志
                    <span class="badge" id="allCountBadge">3</span>
                </button>
            </div>

            <!-- 错误日志标签页 -->
            <div class="debug-content active" id="debug-errors">
                <div class="debug-toolbar">
                    <button class="debug-toolbar-btn" onclick="DebugLog.exportErrors()">📤 导出错误</button>
                    <button class="debug-toolbar-btn danger" onclick="DebugLog.clearErrors()">🗑️ 清空错误</button>
                </div>
                <div class="debug-log-container" id="errorLogContainer">
                    <div class="debug-empty">
                        <div class="debug-empty-icon">✅</div>
                        <p>暂无错误记录</p>
                    </div>
                </div>
            </div>

            <!-- AI交互标签页 -->
            <div class="debug-content" id="debug-ai">
                <div class="debug-toolbar">
                    <button class="debug-toolbar-btn" onclick="DebugLog.exportAI()">📤 导出AI日志</button>
                    <button class="debug-toolbar-btn danger" onclick="DebugLog.clearAI()">🗑️ 清空AI日志</button>
                </div>
                <div class="debug-log-container" id="aiLogContainer">
                    <div class="debug-empty">
                        <div class="debug-empty-icon">🤖</div>
                        <p>暂无AI交互记录</p>
                    </div>
                </div>
            </div>

            <!-- 游戏状态标签页 -->
            <div class="debug-content" id="debug-state">
                <div class="debug-toolbar">
                    <button class="debug-toolbar-btn" onclick="DebugLog.refreshState()">🔄 刷新状态</button>
                    <button class="debug-toolbar-btn" onclick="DebugLog.exportState()">📤 导出状态</button>
                    <button class="debug-toolbar-btn" onclick="DebugLog.copyState()">📋 复制到剪贴板</button>
                </div>
                <div id="stateContainer">
                    <div class="debug-state-section">
                        <div class="debug-state-title">🎮 GameState 完整数据</div>
                        <div class="debug-state-content" id="gameStateDisplay"></div>
                    </div>
                </div>
            </div>

            <!-- 全部日志标签页 -->
            <div class="debug-content" id="debug-all">
                <div class="debug-toolbar">
                    <button class="debug-toolbar-btn" onclick="DebugLog.exportAll()">📤 导出全部</button>
                    <button class="debug-toolbar-btn danger" onclick="DebugLog.clearAll()">🗑️ 清空全部</button>
                </div>
                <div class="debug-log-container" id="allLogContainer">
                    <div class="debug-empty">
                        <div class="debug-empty-icon">📋</div>
                        <p>暂无日志记录</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== Debug日志系统 ====================
        const DebugLog = {
            errors: [],
            aiLogs: [],
            allLogs: [],

            // 获取当前时间戳
            getTimestamp() {
                const now = new Date();
                return now.toLocaleString('zh-CN', {
                    hour12: false,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            },

            // 添加错误日志
            error(source, message, details = null) {
                const log = {
                    id: Date.now(),
                    type: 'error',
                    source: source,
                    message: message,
                    details: details,
                    timestamp: this.getTimestamp()
                };
                this.errors.push(log);
                this.allLogs.push(log);
                this.updateBadges();
                this.updateDebugBtn();
                console.error(`[DEBUG ERROR] ${source}: ${message}`, details);
            },

            // 添加警告日志
            warning(source, message, details = null) {
                const log = {
                    id: Date.now(),
                    type: 'warning',
                    source: source,
                    message: message,
                    details: details,
                    timestamp: this.getTimestamp()
                };
                this.allLogs.push(log);
                this.updateBadges();
                console.warn(`[DEBUG WARNING] ${source}: ${message}`, details);
            },

            // 添加信息日志
            info(source, message, details = null) {
                const log = {
                    id: Date.now(),
                    type: 'info',
                    source: source,
                    message: message,
                    details: details,
                    timestamp: this.getTimestamp()
                };
                this.allLogs.push(log);
                this.updateBadges();
                console.log(`[DEBUG INFO] ${source}: ${message}`, details);
            },

            // 添加成功日志
            success(source, message, details = null) {
                const log = {
                    id: Date.now(),
                    type: 'success',
                    source: source,
                    message: message,
                    details: details,
                    timestamp: this.getTimestamp()
                };
                this.allLogs.push(log);
                this.updateBadges();
                console.log(`[DEBUG SUCCESS] ${source}: ${message}`, details);
            },

            // 添加AI交互日志
            aiRequest(source, prompt, model) {
                const log = {
                    id: Date.now(),
                    type: 'request',
                    source: source,
                    model: model,
                    prompt: prompt,
                    response: null,
                    status: 'pending',
                    timestamp: this.getTimestamp(),
                    duration: null
                };
                this.aiLogs.push(log);
                this.allLogs.push({
                    id: log.id,
                    type: 'info',
                    source: `AI请求 - ${source}`,
                    message: `发送请求到 ${model}`,
                    details: prompt,
                    timestamp: log.timestamp
                });
                this.updateBadges();
                return log.id;
            },

            // 更新AI响应
            aiResponse(logId, response, success = true, error = null) {
                const log = this.aiLogs.find(l => l.id === logId);
                if (log) {
                    log.response = response;
                    log.status = success ? 'success' : 'error';
                    log.error = error;
                    log.duration = Date.now() - log.id;

                    this.allLogs.push({
                        id: Date.now(),
                        type: success ? 'success' : 'error',
                        source: `AI响应 - ${log.source}`,
                        message: success ? `收到响应 (${log.duration}ms)` : `请求失败: ${error}`,
                        details: response,
                        timestamp: this.getTimestamp()
                    });

                    if (!success) {
                        this.errors.push({
                            id: Date.now(),
                            type: 'error',
                            source: `AI错误 - ${log.source}`,
                            message: error,
                            details: { prompt: log.prompt, response: response },
                            timestamp: this.getTimestamp()
                        });
                    }
                }
                this.updateBadges();
                this.updateDebugBtn();
            },

            // 更新徽章数字
            updateBadges() {
                const errorBadge = document.getElementById('errorCountBadge');
                const aiBadge = document.getElementById('aiCountBadge');
                const allBadge = document.getElementById('allCountBadge');

                if (errorBadge) errorBadge.textContent = this.errors.length;
                if (aiBadge) aiBadge.textContent = this.aiLogs.length;
                if (allBadge) allBadge.textContent = this.allLogs.length;
            },

            // 更新Debug按钮状态
            updateDebugBtn() {
                const btn = document.getElementById('debugBtn');
                if (btn) {
                    if (this.errors.length > 0) {
                        btn.classList.add('has-errors');
                        btn.innerHTML = `🐛 Debug (${this.errors.length})`;
                    } else {
                        btn.classList.remove('has-errors');
                        btn.innerHTML = '🐛 Debug';
                    }
                }
            },

            // 渲染错误日志
            renderErrors() {
                const container = document.getElementById('errorLogContainer');
                if (!container) return;

                if (this.errors.length === 0) {
                    container.innerHTML = `
            <div class="debug-empty">
              <div class="debug-empty-icon">✅</div>
              <p>暂无错误记录</p>
            </div>
          `;
                    return;
                }

                container.innerHTML = this.errors.slice().reverse().map(log => `
          <div class="debug-log-item error">
            <div class="debug-log-header">
              <span class="debug-log-type error">❌ ERROR</span>
              <span class="debug-log-time">${log.timestamp}</span>
            </div>
            <div class="debug-log-source">📍 ${log.source}</div>
            <div class="debug-log-message">${this.escapeHtml(log.message)}</div>
            ${log.details ? `
              <button class="debug-log-toggle" onclick="DebugLog.toggleDetails(${log.id})">
                展开详情 ▼
              </button>
              <div class="debug-log-details" id="details-${log.id}" style="display: none;">
${typeof log.details === 'object' ? JSON.stringify(log.details, null, 2) : this.escapeHtml(String(log.details))}
              </div>
            ` : ''}
          </div>
        `).join('');
            },

            // 渲染AI日志
            renderAI() {
                const container = document.getElementById('aiLogContainer');
                if (!container) return;

                if (this.aiLogs.length === 0) {
                    container.innerHTML = `
            <div class="debug-empty">
              <div class="debug-empty-icon">🤖</div>
              <p>暂无AI交互记录</p>
            </div>
          `;
                    return;
                }

                container.innerHTML = this.aiLogs.slice().reverse().map(log => `
          <div class="ai-log-item">
            <div class="ai-log-header">
              <div class="ai-log-title">${log.source}</div>
              <div class="ai-log-meta">
                <span>📡 ${log.model}</span>
                <span>⏱️ ${log.duration ? log.duration + 'ms' : '进行中...'}</span>
                <span class="ai-log-status ${log.status}">${log.status === 'pending' ? '⏳ 请求中' :
                        log.status === 'success' ? '✅ 成功' : '❌ 失败'
                    }</span>
              </div>
            </div>

            <div class="ai-log-section">
              <div class="ai-log-section-title request">📤 发送的提示词</div>
              <div class="ai-log-content collapsed" id="prompt-${log.id}">
${this.escapeHtml(log.prompt)}
              </div>
              <button class="debug-log-toggle" onclick="DebugLog.toggleAIContent('prompt-${log.id}')">
                展开完整内容 ▼
              </button>
            </div>

            <div class="ai-log-section">
              <div class="ai-log-section-title response">📥 收到的响应</div>
              <div class="ai-log-content collapsed" id="response-${log.id}">
${log.response ? this.escapeHtml(log.response) : '(等待响应...)'}
              </div>
              ${log.response ? `
                <button class="debug-log-toggle" onclick="DebugLog.toggleAIContent('response-${log.id}')">
                  展开完整内容 ▼
                </button>
              ` : ''}
            </div>

            ${log.error ? `
              <div class="ai-log-section">
                <div class="ai-log-section-title" style="color: var(--accent-red);">⚠️ 错误信息</div>
                <div class="ai-log-content" style="border: 1px solid var(--accent-red);">
${this.escapeHtml(log.error)}
                </div>
              </div>
            ` : ''}
          </div>
        `).join('');
            },

            // 渲染全部日志
            renderAll() {
                const container = document.getElementById('allLogContainer');
                if (!container) return;

                if (this.allLogs.length === 0) {
                    container.innerHTML = `
            <div class="debug-empty">
              <div class="debug-empty-icon">📋</div>
              <p>暂无日志记录</p>
            </div>
          `;
                    return;
                }

                container.innerHTML = this.allLogs.slice().reverse().map(log => `
          <div class="debug-log-item ${log.type}">
            <div class="debug-log-header">
              <span class="debug-log-type ${log.type}">${this.getTypeIcon(log.type)} ${log.type.toUpperCase()}</span>
              <span class="debug-log-time">${log.timestamp}</span>
            </div>
            <div class="debug-log-source">📍 ${log.source}</div>
            <div class="debug-log-message">${this.escapeHtml(log.message)}</div>
            ${log.details ? `
              <button class="debug-log-toggle" onclick="DebugLog.toggleDetails(${log.id})">
                展开详情 ▼
              </button>
              <div class="debug-log-details" id="details-${log.id}" style="display: none;">
${typeof log.details === 'object' ? JSON.stringify(log.details, null, 2) : this.escapeHtml(String(log.details))}
              </div>
            ` : ''}
          </div>
        `).join('');
            },

            // 刷新游戏状态显示
            refreshState() {
                const display = document.getElementById('gameStateDisplay');
                if (display) {
                    // 创建一个不包含chatHistory的副本（太长了）
                    const stateCopy = JSON.parse(JSON.stringify(GameState));
                    stateCopy.chatHistory = `[${GameState.chatHistory.length} 条消息 - 已省略]`;
                    display.textContent = JSON.stringify(stateCopy, null, 2);
                }
                showNotification('✅ 状态已刷新', 'success');
            },

            // 获取类型图标
            getTypeIcon(type) {
                const icons = {
                    error: '❌',
                    warning: '⚠️',
                    info: 'ℹ️',
                    success: '✅',
                    request: '📤',
                    response: '📥'
                };
                return icons[type] || '📋';
            },

            // HTML转义
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            // 切换详情显示
            toggleDetails(logId) {
                const details = document.getElementById(`details-${logId}`);
                if (details) {
                    const isHidden = details.style.display === 'none';
                    details.style.display = isHidden ? 'block' : 'none';
                    const btn = details.previousElementSibling;
                    if (btn) {
                        btn.textContent = isHidden ? '收起详情 ▲' : '展开详情 ▼';
                    }
                }
            },

            // 切换AI内容显示
            toggleAIContent(elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    const isCollapsed = element.classList.contains('collapsed');
                    element.classList.toggle('collapsed');
                    const btn = element.nextElementSibling;
                    if (btn && btn.classList.contains('debug-log-toggle')) {
                        btn.textContent = isCollapsed ? '收起内容 ▲' : '展开完整内容 ▼';
                    }
                }
            },

            // 导出错误日志
            exportErrors() {
                this.downloadJSON(this.errors, 'error_logs');
            },

            // 导出AI日志
            exportAI() {
                this.downloadJSON(this.aiLogs, 'ai_logs');
            },

            // 导出全部日志
            exportAll() {
                this.downloadJSON({
                    errors: this.errors,
                    aiLogs: this.aiLogs,
                    allLogs: this.allLogs,
                    gameState: GameState
                }, 'all_debug_logs');
            },

            // 导出游戏状态
            exportState() {
                this.downloadJSON(GameState, 'game_state');
            },

            // 复制状态到剪贴板
            async copyState() {
                try {
                    const stateCopy = JSON.parse(JSON.stringify(GameState));
                    stateCopy.chatHistory = `[${GameState.chatHistory.length} 条消息]`;
                    await navigator.clipboard.writeText(JSON.stringify(stateCopy, null, 2));
                    showNotification('✅ 已复制到剪贴板', 'success');
                } catch (e) {
                    showNotification('❌ 复制失败', 'error');
                }
            },

            // 下载JSON文件
            downloadJSON(data, filename) {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification(`✅ 已导出: ${a.download}`, 'success');
            },

            // 清空错误日志
            clearErrors() {
                if (confirm('确定要清空所有错误日志吗？')) {
                    this.errors = [];
                    this.updateBadges();
                    this.updateDebugBtn();
                    this.renderErrors();
                    showNotification('🗑️ 错误日志已清空', 'info');
                }
            },

            // 清空AI日志
            clearAI() {
                if (confirm('确定要清空所有AI交互日志吗？')) {
                    this.aiLogs = [];
                    this.updateBadges();
                    this.renderAI();
                    showNotification('🗑️ AI日志已清空', 'info');
                }
            },

            // 清空全部日志
            clearAll() {
                if (confirm('确定要清空所有日志吗？')) {
                    this.errors = [];
                    this.aiLogs = [];
                    this.allLogs = [];
                    this.updateBadges();
                    this.updateDebugBtn();
                    this.renderErrors();
                    this.renderAI();
                    this.renderAll();
                    showNotification('🗑️ 全部日志已清空', 'info');
                }
            }
        };

        // ==================== 全局错误捕获 ====================
        window.onerror = function (message, source, lineno, colno, error) {
            DebugLog.error('全局错误', message, {
                source: source,
                line: lineno,
                column: colno,
                stack: error ? error.stack : null
            });
            return false;
        };

        window.addEventListener('unhandledrejection', function (event) {
            DebugLog.error('未处理的Promise错误', event.reason ? event.reason.message || String(event.reason) : '未知错误', {
                reason: event.reason
            });
        });

        // ==================== 性格词条定义 ====================
        const PersonalityTraits = [
            { id: 'pure', name: '清纯', defaultDesc: '外表清纯可爱，对性知识几乎一无所知，容易害羞脸红' },
            { id: 'shy', name: '害羞', defaultDesc: '性格内向腼腆，不善于表达，被人注视时会紧张' },
            { id: 'gentle', name: '温柔', defaultDesc: '性格温和体贴，善解人意，说话轻声细语' },
            { id: 'tsundere', name: '傲娇', defaultDesc: '嘴上说不要身体却很诚实，表面高冷内心火热' },
            { id: 'cold', name: '高冷', defaultDesc: '外表冷淡疏离，不轻易对人敞开心扉' },
            { id: 'cheerful', name: '开朗', defaultDesc: '性格阳光活泼，爱笑爱闹，容易和人打成一片' },
            { id: 'obedient', name: '顺从', defaultDesc: '性格软弱容易被支配，难以拒绝他人的要求' },
            { id: 'proud', name: '高傲', defaultDesc: '自尊心极强，看不起普通人，不愿低头' },
            { id: 'innocent', name: '天然', defaultDesc: '思想单纯不谙世事，容易被人欺骗利用' },
            { id: 'sensual', name: '闷骚', defaultDesc: '外表正经内心淫荡，有隐藏的欲望' },
            { id: 'passionate', name: '热情', defaultDesc: '性格火热奔放，感情充沛，容易投入' },
            { id: 'devoted', name: '专一', defaultDesc: '对感情极度忠诚，一旦认定就不会改变' },
            { id: 'sensitive', name: '敏感', defaultDesc: '身体和心理都极其敏感，轻微刺激就有反应' },
            { id: 'masochist', name: '抖M', defaultDesc: '有被虐倾向，被粗暴对待反而会兴奋' },
            { id: 'exhibitionist', name: '暴露癖', defaultDesc: '有在他人面前暴露身体的冲动和快感' }
        ];

        // ==================== 游戏状态 ====================
        const GameState = {
            model: 'nalang-xl-0826',
            protagonist: { name: '', age: 22 },
            heroine: {
                name: '',
                age: 21,
                relation: '',
                identity: '',
                personality: [],
                personalityDesc: {},
                corruptionLevel: 1,
                corruptionExp: 5,
                infidelityValue: 0,
                virginStatus: '完璧',
                cheatingCount: 0,
                sexStats: {
                    oral: 0, handjob: 0, boobjob: 0, footjob: 0,
                    anal: 0, condomSex: 0, creampie: 0, externalCum: 0,
                    threesome: 0, intercrural: 0,
                    orgasms: 0, cumExtracted: 0
                }
            },
            system: { level: 1, exp: 0, expToNext: 100, coins: 0 },
            shelter: {
                level: 1,
                name: '末世之光',
                items: ['压缩饼干x3', '矿泉水x2', '毛毯x1', '应急灯x1']
            },
            gameTime: { year: 2025, month: 12, day: 15, hour: 14, minute: 30, weekday: '星期一' },
            environment: { outdoorTemp: -35, indoorTemp: 18, weather: '阴冷', location: '避难所' },
            currentTasks: { daily: null, bounty: null },
            completedTasks: [],
            abilities: [],
            purchaseHistory: [],
            chatHistory: [],
            saves: [null, null, null],
            // 新增：总结相关状态
            summaryIndex: -1,
            lastUserMessageIndex: -1,
            // 新增：商店搜索缓存
            shopCache: {},  // 格式: { "搜索关键词": [商品数组] }
            shopSearchHistory: []  // 搜索历史记录
        };

        // ==================== 初始化 ====================
        function initPersonalityTags() {
            const container = document.getElementById('personalityTags');
            container.innerHTML = PersonalityTraits.map(trait => `
        <div class="personality-tag" data-id="${trait.id}" onclick="togglePersonalityTag('${trait.id}')">
          ${trait.name}
        </div>
      `).join('');
            DebugLog.info('初始化', '性格词条初始化完成', { count: PersonalityTraits.length });
        }

        function togglePersonalityTag(id) {
            const tag = document.querySelector(`.personality-tag[data-id="${id}"]`);
            tag.classList.toggle('selected');
            updatePersonalityDescriptions();
        }

        function updatePersonalityDescriptions() {
            const container = document.getElementById('personalityDescContainer');
            const selectedTags = document.querySelectorAll('.personality-tag.selected');

            if (selectedTags.length === 0) {
                container.classList.remove('active');
                container.innerHTML = '';
                return;
            }

            container.classList.add('active');
            container.innerHTML = Array.from(selectedTags).map(tag => {
                const id = tag.dataset.id;
                const trait = PersonalityTraits.find(t => t.id === id);
                const savedDesc = GameState.heroine.personalityDesc[id] || trait.defaultDesc;
                return `
          <div class="personality-desc-item">
            <div class="personality-desc-label">${trait.name}</div>
            <input type="text" class="personality-desc-input"
                   data-id="${id}"
                   value="${savedDesc}"
                   onchange="updatePersonalityDesc('${id}', this.value)">
          </div>
        `;
            }).join('');
        }

        function updatePersonalityDesc(id, value) {
            GameState.heroine.personalityDesc[id] = value;
        }

        function handleVirginChange() {
            const select = document.getElementById('virginSelect');
            const options = document.getElementById('virginOptions');

            if (select.value === 'no') {
                options.classList.add('active');
            } else {
                options.classList.remove('active');
            }
        }

        function selectVirginOption(element, value) {
            document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            element.querySelector('input').checked = true;

            const customInput = document.getElementById('customVirginInput');
            if (value === 'custom') {
                customInput.classList.add('active');
            } else {
                customInput.classList.remove('active');
            }
        }

        // ==================== 工具函数 ====================
        function formatGameTime() {
            const t = GameState.gameTime;
            const pad = n => String(n).padStart(2, '0');
            return `${t.year}-${pad(t.month)}-${pad(t.day)} ${pad(t.hour)}:${pad(t.minute)}`;
        }

        function formatShortTime() {
            const t = GameState.gameTime;
            return `${String(t.hour).padStart(2, '0')}:${String(t.minute).padStart(2, '0')}`;
        }

        function getCorruptionStars(level) {
            return '⭐'.repeat(level) + '☆'.repeat(5 - level);
        }

        function getWeekday(date) {
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            return weekdays[date.getDay()];
        }

        function isBountyDay() {
            const wd = GameState.gameTime.weekday;
            return wd === '星期一' || wd === '星期四';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ==================== 判断是否为移动端 ====================
        function isMobile() {
            return window.innerWidth <= 900;
        }

        // ==================== 侧边栏切换（修复移动端问题） ====================
        function toggleSidePanel() {
            const panel = document.getElementById('sidePanel');
            const btn = document.getElementById('togglePanelBtn');
            const overlay = document.getElementById('mobileOverlay');

            if (isMobile()) {
                const isVisible = panel.classList.contains('mobile-visible');
                if (isVisible) {
                    panel.classList.remove('mobile-visible');
                    overlay.classList.remove('active');
                    btn.classList.remove('active');
                } else {
                    panel.classList.add('mobile-visible');
                    overlay.classList.add('active');
                    btn.classList.add('active');
                }
            } else {
                const chat = document.getElementById('chatContainer');
                panel.classList.toggle('collapsed');
                chat.classList.toggle('expanded');
                btn.classList.toggle('active');
            }
        }

        // ==================== 关闭侧边栏（点击遮罩时） ====================
        function closeSidePanel() {
            const panel = document.getElementById('sidePanel');
            const btn = document.getElementById('togglePanelBtn');
            const overlay = document.getElementById('mobileOverlay');

            panel.classList.remove('mobile-visible');
            overlay.classList.remove('active');
            btn.classList.remove('active');
        }

        // ==================== Debug模态框 ====================
        function openDebugModal() {
            document.getElementById('debugModal').classList.add('active');
            DebugLog.refreshState();
            DebugLog.renderErrors();
            DebugLog.renderAI();
            DebugLog.renderAll();
            DebugLog.info('Debug', '打开Debug面板');
        }

        function closeDebugModal() {
            document.getElementById('debugModal').classList.remove('active');
        }

        function switchDebugTab(tabName) {
            document.querySelectorAll('.debug-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.debugTab === tabName);
            });
            document.querySelectorAll('.debug-content').forEach(content => {
                content.classList.toggle('active', content.id === `debug-${tabName}`);
            });

            if (tabName === 'errors') DebugLog.renderErrors();
            if (tabName === 'ai') DebugLog.renderAI();
            if (tabName === 'all') DebugLog.renderAll();
            if (tabName === 'state') DebugLog.refreshState();
        }

        // ==================== 作弊模态框 ====================
        function openCheatModal() {
            closeModelModal();
            document.getElementById('cheatModal').classList.add('active');
            loadCheatValues();
            DebugLog.info('作弊系统', '打开作弊面板');
        }

        function closeCheatModal() {
            document.getElementById('cheatModal').classList.remove('active');
        }

        // 加载当前游戏数值到作弊面板
        function loadCheatValues() {
            // 系统数值
            document.getElementById('cheatCoins').value = GameState.system.coins;
            document.getElementById('cheatExp').value = GameState.system.exp;
            document.getElementById('cheatLevel').value = GameState.system.level;

            // 女主角数值
            document.getElementById('cheatCorruptionLevel').value = GameState.heroine.corruptionLevel;
            document.getElementById('cheatCorruptionExp').value = GameState.heroine.corruptionExp;
            document.getElementById('cheatInfidelity').value = GameState.heroine.infidelityValue;
            document.getElementById('cheatCheatingCount').value = GameState.heroine.cheatingCount;
            document.getElementById('cheatVirginStatus').value = GameState.heroine.virginStatus;

            // 性经验统计
            document.getElementById('cheatOral').value = GameState.heroine.sexStats.oral;
            document.getElementById('cheatHandjob').value = GameState.heroine.sexStats.handjob;
            document.getElementById('cheatBoobjob').value = GameState.heroine.sexStats.boobjob;
            document.getElementById('cheatFootjob').value = GameState.heroine.sexStats.footjob;
            document.getElementById('cheatAnal').value = GameState.heroine.sexStats.anal;
            document.getElementById('cheatCondomSex').value = GameState.heroine.sexStats.condomSex;
            document.getElementById('cheatCreampie').value = GameState.heroine.sexStats.creampie;
            document.getElementById('cheatExternalCum').value = GameState.heroine.sexStats.externalCum;
            document.getElementById('cheatThreesome').value = GameState.heroine.sexStats.threesome;
            document.getElementById('cheatIntercrural').value = GameState.heroine.sexStats.intercrural;
            document.getElementById('cheatOrgasms').value = GameState.heroine.sexStats.orgasms;
            document.getElementById('cheatCumExtracted').value = GameState.heroine.sexStats.cumExtracted;

            // 环境设置
            document.getElementById('cheatOutdoorTemp').value = GameState.environment.outdoorTemp;
            document.getElementById('cheatIndoorTemp').value = GameState.environment.indoorTemp;
            document.getElementById('cheatLocation').value = GameState.environment.location;
            document.getElementById('cheatWeather').value = GameState.environment.weather;

            // 避难所设置
            document.getElementById('cheatShelterLevel').value = GameState.shelter.level;
            document.getElementById('cheatShelterName').value = GameState.shelter.name;

            DebugLog.info('作弊系统', '已加载当前游戏数值');
        }

        // 应用作弊修改
        function applyCheat() {
            // 系统数值
            GameState.system.coins = parseInt(document.getElementById('cheatCoins').value) || 0;
            GameState.system.exp = parseInt(document.getElementById('cheatExp').value) || 0;
            GameState.system.level = parseInt(document.getElementById('cheatLevel').value) || 1;

            // 女主角数值
            GameState.heroine.corruptionLevel = Math.min(5, Math.max(1, parseInt(document.getElementById('cheatCorruptionLevel').value) || 1));
            GameState.heroine.corruptionExp = Math.min(100, Math.max(0, parseInt(document.getElementById('cheatCorruptionExp').value) || 0));
            GameState.heroine.infidelityValue = Math.min(100, Math.max(0, parseInt(document.getElementById('cheatInfidelity').value) || 0));
            GameState.heroine.cheatingCount = parseInt(document.getElementById('cheatCheatingCount').value) || 0;
            GameState.heroine.virginStatus = document.getElementById('cheatVirginStatus').value || '完璧';

            // 性经验统计
            GameState.heroine.sexStats.oral = parseInt(document.getElementById('cheatOral').value) || 0;
            GameState.heroine.sexStats.handjob = parseInt(document.getElementById('cheatHandjob').value) || 0;
            GameState.heroine.sexStats.boobjob = parseInt(document.getElementById('cheatBoobjob').value) || 0;
            GameState.heroine.sexStats.footjob = parseInt(document.getElementById('cheatFootjob').value) || 0;
            GameState.heroine.sexStats.anal = parseInt(document.getElementById('cheatAnal').value) || 0;
            GameState.heroine.sexStats.condomSex = parseInt(document.getElementById('cheatCondomSex').value) || 0;
            GameState.heroine.sexStats.creampie = parseInt(document.getElementById('cheatCreampie').value) || 0;
            GameState.heroine.sexStats.externalCum = parseInt(document.getElementById('cheatExternalCum').value) || 0;
            GameState.heroine.sexStats.threesome = parseInt(document.getElementById('cheatThreesome').value) || 0;
            GameState.heroine.sexStats.intercrural = parseInt(document.getElementById('cheatIntercrural').value) || 0;
            GameState.heroine.sexStats.orgasms = parseInt(document.getElementById('cheatOrgasms').value) || 0;
            GameState.heroine.sexStats.cumExtracted = parseInt(document.getElementById('cheatCumExtracted').value) || 0;

            // 环境设置
            GameState.environment.outdoorTemp = parseInt(document.getElementById('cheatOutdoorTemp').value) || -35;
            GameState.environment.indoorTemp = parseInt(document.getElementById('cheatIndoorTemp').value) || 18;
            GameState.environment.location = document.getElementById('cheatLocation').value || '避难所';
            GameState.environment.weather = document.getElementById('cheatWeather').value || '阴冷';

            // 避难所设置
            GameState.shelter.level = parseInt(document.getElementById('cheatShelterLevel').value) || 1;
            GameState.shelter.name = document.getElementById('cheatShelterName').value || '末世之光';

            // 更新UI
            updateAllUI();

            // 关闭作弊面板
            closeCheatModal();

            showNotification('✅ 作弊数值已应用！', 'success');
            DebugLog.success('作弊系统', '已应用作弊修改', {
                coins: GameState.system.coins,
                level: GameState.system.level,
                corruptionLevel: GameState.heroine.corruptionLevel
            });
        }

        // ==================== 任务系统 ====================
        function getTaskLevelDescription(level, isBounty = false) {
            const effectiveLevel = isBounty ? Math.min(level + 1, 5) : level;
            const descriptions = {
                1: '简单的身体接触（握手、拥抱、眼神接触等）',
                2: '裸露和触摸身体（展示身材、被摸胸、被摸臀等）',
                3: '口交和足交等非插入性行为（口交、足交、乳交等，避免性交）',
                4: '完整的性交行为（阴道性交、肛交、内射等）',
                5: isBounty ? '长时间的轮奸、公共肉便器、极端群交等' : '群交和多P行为（3P、轮奸、多人性交等）'
            };
            return descriptions[effectiveLevel] || descriptions[1];
        }

        async function generateDailyTask() {
            const level = GameState.heroine.corruptionLevel;
            const levelDesc = getTaskLevelDescription(level, false);
            const container = document.getElementById('dailyTaskContainer');

            container.innerHTML = `
        <div class="task-loading">
          <div class="task-loading-spinner"></div>
          正在生成任务...
        </div>
      `;

            DebugLog.info('任务系统', '开始生成每日任务', { level: level });

            const prompt = `你是末世寝取生存游戏的任务生成系统。这是一款以寝取（NTR）为核心玩法的成人游戏。
【背景设定】
极寒末世，文明崩溃。主角${GameState.protagonist.name}和女友${GameState.heroine.name}躲在避难所生存。
主角拥有"寝取系统"，通过让女友与其他男性发生亲密接触来获取资源。
女主角：${GameState.heroine.name}，${GameState.heroine.age}岁，${GameState.heroine.identity}，是主角的${GameState.heroine.relation}
【当前淫乱等级】${level}星
【任务尺度要求】${levelDesc}
【任务设计规则】
1. 任务必须是让女主角与任意【其他男性】发生指定尺度的亲密接触
2. 任务对象没有任何限制,但不能是${GameState.protagonist.name}
请生成1个每日任务，严格按照以下JSON格式返回：
{
  "content": "任务描述，简单叙述任务要求",
  "coins": ${level * 15}到${level * 30}之间的整数,
  "exp": ${level * 20}到${level * 40}之间的整数
}
【示例参考】
1星: "让${GameState.heroine.name}寻找任意男性，允许对方握住她的手并凝视她30秒"
2星: "让${GameState.heroine.name}在任意男性面前脱掉上衣让其抚摸检查她的胸部"
3星: "让${GameState.heroine.name}给任意男性口交一次并吞精"
4星: "让${GameState.heroine.name}被人以男性插入并射精"
5星: "让${GameState.heroine.name}一天内被至少4名男性中出"
只返回JSON，不要任何其他文字。`;

            const logId = DebugLog.aiRequest('生成每日任务', prompt, GameState.model);

            try {
                let fullResponse = '';
                await dzmm.completions({
                    model: GameState.model,
                    messages: [{ role: 'user', content: prompt }],
                    maxTokens: 500
                }, (content, done) => {
                    fullResponse = content;
                    if (done) {
                        DebugLog.aiResponse(logId, fullResponse, true);

                        try {
                            const jsonMatch = fullResponse.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                const taskData = JSON.parse(jsonMatch[0]);
                                GameState.currentTasks.daily = {
                                    type: '每日任务',
                                    content: taskData.content,
                                    rewards: { coins: taskData.coins, exp: taskData.exp },
                                    level: level,
                                    status: 'pending'
                                };
                                updateTaskUI();
                                DebugLog.success('任务系统', '每日任务生成成功', taskData);
                            } else {
                                throw new Error('无法从响应中解析JSON');
                            }
                        } catch (e) {
                            DebugLog.error('任务系统', '每日任务JSON解析失败', {
                                error: e.message,
                                response: fullResponse
                            });
                            container.innerHTML = `<div style="color: var(--accent-red); font-size: 0.8rem;">任务生成失败，请重试</div>`;
                        }
                    }
                });
            } catch (error) {
                DebugLog.aiResponse(logId, null, false, error.message);
                DebugLog.error('任务系统', '每日任务API请求失败', { error: error.message });
                container.innerHTML = `<div style="color: var(--accent-red); font-size: 0.8rem;">任务生成失败: ${error.message}</div>`;
            }
        }

        async function generateBountyTask() {
            if (!isBountyDay()) {
                showNotification('悬赏任务仅在周一/周四开放', 'warning');
                DebugLog.warning('任务系统', '尝试在非悬赏日生成悬赏任务', { weekday: GameState.gameTime.weekday });
                return;
            }

            const level = GameState.heroine.corruptionLevel;
            const effectiveLevel = Math.min(level + 1, 5);
            const levelDesc = getTaskLevelDescription(level, true);
            const container = document.getElementById('bountyTaskContainer');

            container.innerHTML = `
        <div class="task-loading">
          <div class="task-loading-spinner"></div>
          正在生成悬赏任务...
        </div>
      `;

            DebugLog.info('任务系统', '开始生成悬赏任务', { level: level, effectiveLevel: effectiveLevel });

            const prompt = `你是末世寝取生存游戏的悬赏任务生成系统。这是一款以寝取（NTR）为核心玩法的成人游戏。
【背景设定】
极寒末世，文明崩溃。主角${GameState.protagonist.name}和女友${GameState.heroine.name}躲在避难所生存。
主角拥有"寝取系统"，通过让女友与其他男性发生亲密接触来获取资源。
女主角：${GameState.heroine.name}，${GameState.heroine.age}岁，${GameState.heroine.identity}，是主角的${GameState.heroine.relation}
【当前淫乱等级】${level}星
【悬赏难度】${effectiveLevel}星（比每日任务高一级，更危险更刺激）
【任务尺度要求】${levelDesc}
【任务设计规则】
1. 悬赏任务比每日任务更极端，涉及更多人数或更羞耻的场景
2. 任务对象没有任何限制，但不能是${GameState.protagonist.name}
3. 可以涉及公开场合、多人、连续性行为
请生成1个悬赏任务，严格按照以下JSON格式返回：
{
  "content": "任务描述，简单叙述任务要求，要比每日任务更刺激",
  "coins": ${effectiveLevel * 30}到${effectiveLevel * 50}之间的整数,
  "exp": ${effectiveLevel * 40}到${effectiveLevel * 60}之间的整数
}
【示例参考】
1星: "让${GameState.heroine.name}在公共场所露出胸部"
2星: "让${GameState.heroine.name}被人以男性玩弄乳头到高潮"
3星: "让${GameState.heroine.name}在一天内至少给两人口交吞精"
4星: "让${GameState.heroine.name}在一天内至少被4人中出射精"
5星: "让${GameState.heroine.name}在公共厕所作为公共肉便器直到第二天"
只返回JSON，不要任何其他文字。`;

            const logId = DebugLog.aiRequest('生成悬赏任务', prompt, GameState.model);

            try {
                let fullResponse = '';
                await dzmm.completions({
                    model: GameState.model,
                    messages: [{ role: 'user', content: prompt }],
                    maxTokens: 600
                }, (content, done) => {
                    fullResponse = content;
                    if (done) {
                        DebugLog.aiResponse(logId, fullResponse, true);

                        try {
                            const jsonMatch = fullResponse.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                const taskData = JSON.parse(jsonMatch[0]);
                                GameState.currentTasks.bounty = {
                                    type: '悬赏任务',
                                    content: taskData.content,
                                    rewards: { coins: taskData.coins, exp: taskData.exp },
                                    level: effectiveLevel,
                                    status: 'pending'
                                };
                                updateTaskUI();
                                DebugLog.success('任务系统', '悬赏任务生成成功', taskData);
                            } else {
                                throw new Error('无法从响应中解析JSON');
                            }
                        } catch (e) {
                            DebugLog.error('任务系统', '悬赏任务JSON解析失败', {
                                error: e.message,
                                response: fullResponse
                            });
                            container.innerHTML = `<div style="color: var(--accent-red); font-size: 0.8rem;">悬赏任务生成失败</div>`;
                        }
                    }
                });
            } catch (error) {
                DebugLog.aiResponse(logId, null, false, error.message);
                DebugLog.error('任务系统', '悬赏任务API请求失败', { error: error.message });
                container.innerHTML = `<div style="color: var(--accent-red); font-size: 0.8rem;">悬赏任务生成失败</div>`;
            }
        }

        function completeTask(taskType) {
            const task = GameState.currentTasks[taskType];
            if (!task || task.status === 'completed') return;

            task.status = 'completed';
            GameState.system.coins += task.rewards.coins;
            GameState.system.exp += task.rewards.exp;

            DebugLog.info('任务系统', `完成${taskType === 'daily' ? '每日' : '悬赏'}任务`, {
                task: task.content,
                rewards: task.rewards
            });

            while (GameState.system.exp >= GameState.system.expToNext) {
                GameState.system.exp -= GameState.system.expToNext;
                GameState.system.level++;
                GameState.system.expToNext = Math.floor(GameState.system.expToNext * 1.5);
                showNotification(`🎉 寝取等级提升至 Lv.${GameState.system.level}！`, 'success');
                DebugLog.success('升级系统', `等级提升到 Lv.${GameState.system.level}`);
            }

            GameState.heroine.infidelityValue = Math.min(100, GameState.heroine.infidelityValue + 5);
            GameState.heroine.corruptionExp += 15;
            if (GameState.heroine.corruptionExp >= 100 && GameState.heroine.corruptionLevel < 5) {
                GameState.heroine.corruptionExp = 0;
                GameState.heroine.corruptionLevel++;
                showNotification(`💔 ${GameState.heroine.name}的淫乱等级提升至 ${GameState.heroine.corruptionLevel}星！`, 'info');
                DebugLog.info('堕落系统', `淫乱等级提升到 ${GameState.heroine.corruptionLevel}星`);
            }

            GameState.completedTasks.push({ ...task, completedAt: formatGameTime() });
            showNotification(`✅ 任务完成！获得 ${task.rewards.coins}💰 ${task.rewards.exp}经验`, 'success');

            updateAllUI();
        }

        // ==================== 时间系统 ====================
        async function advanceTime(hours) {
            const t = GameState.gameTime;
            const date = new Date(t.year, t.month - 1, t.day, t.hour, t.minute);
            date.setHours(date.getHours() + hours);

            GameState.gameTime = {
                year: date.getFullYear(),
                month: date.getMonth() + 1,
                day: date.getDate(),
                hour: date.getHours(),
                minute: date.getMinutes(),
                weekday: getWeekday(date)
            };

            DebugLog.info('时间系统', `时间推进 ${hours} 小时`, { newTime: formatGameTime() });

            updateAllUI();

            if (hours >= 24) {
                const days = Math.floor(hours / 24);
                showTypingIndicator();

                const prompt = `时间快进了${days}天。请简要描述这${days}天内发生的事情：

1. 女主角${GameState.heroine.name}是否执行了任务？
2. 任务过程中发生了什么？
3. 她的状态有什么变化？

当前淫乱等级：${GameState.heroine.corruptionLevel}星
当前任务：${GameState.currentTasks.daily ? GameState.currentTasks.daily.content : '无'}

请用600-800字描述，包含适当的色情细节。
最后用【状态变化】标注数值变动。`;

                await sendToAI(prompt);
            } else {
                showNotification(`⏰ 时间推进了${hours}小时`, 'info');
            }
        }

        // ==================== UI更新 ====================
        function updateAllUI() {
            // 头部
            document.getElementById('headerCoins').textContent = GameState.system.coins;
            document.getElementById('headerLevel').textContent = `Lv.${GameState.system.level}`;
            document.getElementById('headerTime').textContent = formatShortTime();
            document.getElementById('headerCorruption').textContent = GameState.heroine.corruptionLevel;

            // 全局状态
            document.getElementById('gameTime').textContent = formatGameTime();
            document.getElementById('gameWeekday').textContent = GameState.gameTime.weekday;
            document.getElementById('gameLocation').textContent = GameState.environment.location;
            document.getElementById('outdoorTemp').textContent = `${GameState.environment.outdoorTemp}°C`;
            document.getElementById('indoorTemp').textContent = `${GameState.environment.indoorTemp}°C`;
            document.getElementById('weather').textContent = GameState.environment.weather;

            // 系统
            document.getElementById('systemLevel').textContent = `Lv.${GameState.system.level}`;
            document.getElementById('systemExp').textContent = `${GameState.system.exp} / ${GameState.system.expToNext}`;
            document.getElementById('systemCoins').textContent = `${GameState.system.coins} 💰`;

            // 避难所
            document.getElementById('shelterLevel').textContent = `Lv.${GameState.shelter.level} ${GameState.shelter.name}`;
            document.getElementById('inventoryList').innerHTML = GameState.shelter.items.map(item =>
                `<span class="inventory-item">${item}</span>`
            ).join('');

            // 能力
            const abilitiesList = document.getElementById('abilitiesList');
            if (GameState.abilities.length > 0) {
                abilitiesList.innerHTML = GameState.abilities.map(a => `
          <div class="ability-card">
            <div class="ability-name">${a.name}</div>
            <div class="ability-desc">${a.desc}</div>
          </div>
        `).join('');
            } else {
                abilitiesList.innerHTML = '<div style="color: var(--text-muted); font-size: 0.75rem;">暂无特殊能力</div>';
            }

            // 女主角
            document.getElementById('heroineDisplayName').textContent = GameState.heroine.name;
            document.getElementById('heroineDisplayRelation').textContent = GameState.heroine.relation;
            document.getElementById('heroineDisplayAge').textContent = `${GameState.heroine.age}岁`;
            document.getElementById('heroineDisplayIdentity').textContent = GameState.heroine.identity;
            document.getElementById('heroineDisplayPersonality').textContent =
                GameState.heroine.personality.length > 0 ?
                    GameState.heroine.personality.map(id => PersonalityTraits.find(t => t.id === id)?.name).join('、') : '-';

            // 堕落数据
            document.getElementById('corruptionStars').textContent = getCorruptionStars(GameState.heroine.corruptionLevel);
            document.getElementById('corruptionBar').style.width = `${GameState.heroine.corruptionExp}%`;
            document.getElementById('infidelityValue').textContent = `${GameState.heroine.infidelityValue}%`;
            document.getElementById('virginStatus').textContent = GameState.heroine.virginStatus;
            document.getElementById('cheatingCount').textContent = GameState.heroine.cheatingCount;

            // 性经验
            const stats = GameState.heroine.sexStats;
            const statsLabels = {
                oral: '口部侍奉', handjob: '手部侍奉', boobjob: '乳部侍奉', footjob: '足部侍奉',
                anal: '肛门性交', condomSex: '戴套性交', creampie: '无套内射', externalCum: '体外射精',
                threesome: '3P/乱交', intercrural: '素股',
                orgasms: '高潮次数', cumExtracted: '榨精(ml)'
            };
            document.getElementById('sexStatsGrid').innerHTML = Object.entries(stats).map(([key, value]) => `
        <div class="sex-stat">
          <span class="status-label">${statsLabels[key]}</span>
          <span class="status-value ${value > 0 ? 'pink' : ''}">${value}</span>
        </div>
      `).join('');

            updateTaskUI();

            if (document.getElementById('shopCoins')) {
                document.getElementById('shopCoins').textContent = `${GameState.system.coins} 💰`;
            }
        }

        function updateTaskUI() {
            // 每日任务
            const dailyContainer = document.getElementById('dailyTaskContainer');
            const task = GameState.currentTasks.daily;

            if (task) {
                const canRefresh = task.status === 'completed';
                dailyContainer.innerHTML = `
          <div class="task-card ${task.status === 'completed' ? 'completed' : ''}">
            <div class="task-header">
              <div class="task-type">💚 每日任务</div>
              <div class="task-level">${task.level}星难度</div>
            </div>
            <div class="task-content">${task.content}</div>
            <div class="task-rewards">
              <span class="task-reward coins">💰 +${task.rewards.coins}</span>
              <span class="task-reward exp">📈 +${task.rewards.exp}</span>
            </div>
            <span class="task-status ${task.status}">${task.status === 'pending' ? '进行中' : '已完成'}</span>
            <div class="task-actions">
              ${task.status === 'pending' ? `
                <button class="task-btn complete" onclick="completeTask('daily')">✅ 完成任务</button>
              ` : ''}
              <button class="task-btn refresh" onclick="generateDailyTask()" ${!canRefresh ? 'disabled' : ''}>
                🔄 ${canRefresh ? '刷新任务' : '完成后可刷新'}
              </button>
            </div>
          </div>
        `;
            } else {
                dailyContainer.innerHTML = `
          <div class="task-card">
            <div class="task-content" style="color: var(--text-muted);">暂无任务</div>
            <div class="task-actions">
              <button class="task-btn refresh" onclick="generateDailyTask()">🔄 生成任务</button>
            </div>
          </div>
        `;
            }

            // 悬赏任务
            const bountyContainer = document.getElementById('bountyTaskContainer');
            const bounty = GameState.currentTasks.bounty;
            const canShowBounty = isBountyDay();

            if (bounty) {
                const canRefresh = bounty.status === 'completed' && canShowBounty;
                bountyContainer.innerHTML = `
          <div class="task-card bounty ${bounty.status === 'completed' ? 'completed' : ''}">
            <div class="task-header">
              <div class="task-type">💛 悬赏任务</div>
              <div class="task-level">${bounty.level}星难度</div>
            </div>
            <div class="task-content">${bounty.content}</div>
            <div class="task-rewards">
              <span class="task-reward coins">💰 +${bounty.rewards.coins}</span>
              <span class="task-reward exp">📈 +${bounty.rewards.exp}</span>
            </div>
            <span class="task-status ${bounty.status}">${bounty.status === 'pending' ? '进行中' : '已完成'}</span>
            <div class="task-actions">
              ${bounty.status === 'pending' ? `
                <button class="task-btn complete" onclick="completeTask('bounty')">✅ 完成任务</button>
              ` : ''}
              ${canShowBounty ? `
                <button class="task-btn refresh" onclick="generateBountyTask()" ${!canRefresh ? 'disabled' : ''}>
                  🔄 ${canRefresh ? '刷新悬赏' : '完成后可刷新'}
                </button>
              ` : ''}
            </div>
          </div>
        `;
            } else if (canShowBounty) {
                bountyContainer.innerHTML = `
          <div class="task-card bounty">
            <div class="task-content" style="color: var(--text-muted);">今天是悬赏日！</div>
            <div class="task-actions">
              <button class="task-btn refresh" onclick="generateBountyTask()">🔄 生成悬赏任务</button>
            </div>
          </div>
        `;
            } else {
                bountyContainer.innerHTML = `
          <div style="color: var(--text-muted); font-size: 0.75rem;">
            悬赏任务仅在周一/周四开放<br>
            当前: ${GameState.gameTime.weekday}
          </div>
        `;
            }

            // 已完成任务
            const completedContainer = document.getElementById('completedTasksContainer');
            if (GameState.completedTasks.length > 0) {
                completedContainer.innerHTML = GameState.completedTasks.slice(-5).reverse().map(t => `
          <div class="task-card completed" style="opacity: 0.6;">
            <div class="task-content" style="font-size: 0.75rem;">${t.content}</div>
            <span class="task-status completed">✅ 已完成</span>
          </div>
        `).join('');
            } else {
                completedContainer.innerHTML = '<div style="color: var(--text-muted); font-size: 0.75rem;">暂无完成记录</div>';
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tabName}`);
            });
        }

        // ==================== 消息系统 ====================
        function addMessage(role, content, isSummary = false) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${role}${isSummary ? ' summary' : ''}`;

            const messageIndex = GameState.chatHistory.length;
            const sender = role === 'user' ? GameState.protagonist.name : '系统叙述';
            const summaryBadge = isSummary ? '<span class="summary-badge">📝 剧情总结</span>' : '';

            div.innerHTML = `
        <div class="message-sender">${sender}${summaryBadge}</div>
        <div class="message-bubble">${formatContent(content)}</div>
      `;

            div.dataset.messageIndex = messageIndex;

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;

            GameState.chatHistory.push({ role, content, isSummary: isSummary });

            if (isSummary) {
                GameState.summaryIndex = messageIndex;
                DebugLog.info('总结系统', '已创建总结，之前的消息将被屏蔽', { summaryIndex: messageIndex });
            }

            if (role === 'user') {
                GameState.lastUserMessageIndex = messageIndex;
            }

            DebugLog.info('消息系统', `添加${role === 'user' ? '用户' : 'AI'}消息`, {
                length: content.length,
                preview: content.substring(0, 100) + '...',
                isSummary: isSummary
            });

            updateLastMessageActions();
        }

        function updateLastMessageActions() {
            const container = document.getElementById('chatMessages');
            const messages = container.querySelectorAll('.message');

            messages.forEach(msg => {
                const actions = msg.querySelector('.message-actions');
                if (actions) actions.remove();
            });

            if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                const lastIndex = parseInt(lastMessage.dataset.messageIndex);
                const lastHistoryItem = GameState.chatHistory[lastIndex];

                if (lastHistoryItem) {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'message-actions';

                    if (lastHistoryItem.role === 'assistant') {
                        actionsDiv.innerHTML = `
              <button class="message-action-btn edit" onclick="editMessage(${lastIndex})">✏️ 编辑</button>
              <button class="message-action-btn regenerate" onclick="regenerateMessage()">🔄 重新生成</button>
            `;
                    } else {
                        actionsDiv.innerHTML = `
              <button class="message-action-btn edit" onclick="editMessage(${lastIndex})">✏️ 编辑</button>
            `;
                    }

                    lastMessage.appendChild(actionsDiv);
                }
            }
        }

        function editMessage(index) {
            const container = document.getElementById('chatMessages');
            const messages = container.querySelectorAll('.message');
            let targetMessage = null;

            messages.forEach(msg => {
                if (parseInt(msg.dataset.messageIndex) === index) {
                    targetMessage = msg;
                }
            });

            if (!targetMessage) return;

            const historyItem = GameState.chatHistory[index];
            const bubble = targetMessage.querySelector('.message-bubble');
            const originalContent = historyItem.content;

            const actions = targetMessage.querySelector('.message-actions');
            if (actions) actions.style.display = 'none';

            const editContainer = document.createElement('div');
            editContainer.className = 'message-edit-container';
            editContainer.id = `edit-container-${index}`;
            editContainer.innerHTML = `
        <textarea class="message-edit-textarea" id="edit-textarea-${index}">${originalContent}</textarea>
        <div class="message-edit-actions">
          <button class="message-edit-btn cancel" onclick="cancelEdit(${index})">取消</button>
          <button class="message-edit-btn save" onclick="saveEdit(${index})">保存</button>
        </div>
      `;

            bubble.style.display = 'none';
            targetMessage.appendChild(editContainer);

            document.getElementById(`edit-textarea-${index}`).focus();

            DebugLog.info('编辑系统', '开始编辑消息', { index: index });
        }

        function saveEdit(index) {
            const textarea = document.getElementById(`edit-textarea-${index}`);
            const newContent = textarea.value.trim();

            if (!newContent) {
                showNotification('消息内容不能为空', 'error');
                return;
            }

            GameState.chatHistory[index].content = newContent;

            const container = document.getElementById('chatMessages');
            const messages = container.querySelectorAll('.message');
            let targetMessage = null;

            messages.forEach(msg => {
                if (parseInt(msg.dataset.messageIndex) === index) {
                    targetMessage = msg;
                }
            });

            if (targetMessage) {
                const bubble = targetMessage.querySelector('.message-bubble');
                bubble.innerHTML = formatContent(newContent);
                bubble.style.display = 'block';

                const editContainer = document.getElementById(`edit-container-${index}`);
                if (editContainer) editContainer.remove();

                const actions = targetMessage.querySelector('.message-actions');
                if (actions) actions.style.display = 'flex';
            }

            showNotification('✅ 消息已更新', 'success');
            DebugLog.success('编辑系统', '消息编辑完成', { index: index });
        }

        function cancelEdit(index) {
            const container = document.getElementById('chatMessages');
            const messages = container.querySelectorAll('.message');
            let targetMessage = null;

            messages.forEach(msg => {
                if (parseInt(msg.dataset.messageIndex) === index) {
                    targetMessage = msg;
                }
            });

            if (targetMessage) {
                const bubble = targetMessage.querySelector('.message-bubble');
                bubble.style.display = 'block';

                const editContainer = document.getElementById(`edit-container-${index}`);
                if (editContainer) editContainer.remove();

                const actions = targetMessage.querySelector('.message-actions');
                if (actions) actions.style.display = 'flex';
            }

            DebugLog.info('编辑系统', '取消编辑', { index: index });
        }

        async function regenerateMessage() {
            let lastUserIndex = -1;
            for (let i = GameState.chatHistory.length - 1; i >= 0; i--) {
                if (GameState.chatHistory[i].role === 'user') {
                    lastUserIndex = i;
                    break;
                }
            }

            if (lastUserIndex === -1) {
                showNotification('没有找到用户消息', 'error');
                return;
            }

            const lastUserMessage = GameState.chatHistory[lastUserIndex].content;

            const lastIndex = GameState.chatHistory.length - 1;
            if (GameState.chatHistory[lastIndex].role === 'assistant') {
                GameState.chatHistory.pop();

                const container = document.getElementById('chatMessages');
                const messages = container.querySelectorAll('.message');
                if (messages.length > 0) {
                    messages[messages.length - 1].remove();
                }
            }

            DebugLog.info('重新生成', '开始重新生成AI响应', { userMessage: lastUserMessage.substring(0, 50) + '...' });

            showTypingIndicator();
            document.getElementById('sendBtn').disabled = true;

            await sendToAI(lastUserMessage, true);

            document.getElementById('sendBtn').disabled = false;
        }

        function formatContent(content) {
            return content
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/「(.+?)」/g, '<span style="color: var(--accent-cyan);">「$1」</span>')
                .replace(/（(.+?)）/g, '<span style="color: var(--text-muted); font-style: italic;">（$1）</span>');
        }

        function showTypingIndicator() {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'message assistant';
            div.id = 'typingIndicator';
            div.innerHTML = `
        <div class="message-sender">系统叙述</div>
        <div class="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        // ==================== 总结系统 ====================
        function prepareSummary() {
            const defaultSummaryPrompt = `请对之前的剧情进行总结，要求：

1. 概括主要剧情发展和关键事件
2. 记录女主角${GameState.heroine.name}的状态变化和心理转变
3. 总结已完成的任务和获得的奖励
4. 保留重要的角色关系和情感发展
5. 记录当前的游戏状态（位置、时间、资源等）

请用500-800字进行总结，保留关键细节以便后续剧情衔接。
总结完成后，在结尾添加【总结完成】标记。`;

            const input = document.getElementById('userInput');
            input.value = defaultSummaryPrompt;
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 120) + 'px';
            input.focus();

            showNotification('📝 总结提示词已填入，可以修改后发送', 'info');
            DebugLog.info('总结系统', '准备总结提示词');
        }

        // ==================== AI交互 ====================
        async function sendToAI(userMessage, isRegenerate = false) {
            const systemPrompt = buildSystemPrompt();
            const messages = [
                { role: 'user', content: systemPrompt },
                { role: 'assistant', content: '明白，我将作为末世寝取生存游戏的叙事系统进行创作。' }
            ];

            let effectiveHistory = [];
            if (GameState.summaryIndex >= 0) {
                effectiveHistory = GameState.chatHistory.slice(GameState.summaryIndex);
                DebugLog.info('总结系统', '使用总结后的历史记录', {
                    summaryIndex: GameState.summaryIndex,
                    effectiveCount: effectiveHistory.length
                });
            } else {
                effectiveHistory = GameState.chatHistory.slice(-8);
            }

            const historyToUse = isRegenerate ? effectiveHistory.slice(0, -1) : effectiveHistory;

            for (const msg of historyToUse) {
                messages.push({ role: msg.role, content: msg.content });
            }

            if (!isRegenerate) {
                messages.push({ role: 'user', content: userMessage });
            }

            const fullPromptForLog = `=== System Prompt ===\n${systemPrompt}\n\n=== 历史消息 (${historyToUse.length}条) ===\n${historyToUse.map(m => `[${m.role}]: ${m.content.substring(0, 200)}...`).join('\n')}\n\n=== 当前用户消息 ===\n${userMessage}`;

            const logId = DebugLog.aiRequest('主对话', fullPromptForLog, GameState.model);

            try {
                let fullResponse = '';
                await dzmm.completions({
                    model: GameState.model,
                    messages: messages,
                    maxTokens: 2000
                }, (content, done) => {
                    fullResponse = content;
                    if (done) {
                        removeTypingIndicator();
                        DebugLog.aiResponse(logId, fullResponse, true);
                        processAIResponse(fullResponse, userMessage);
                    }
                });
            } catch (error) {
                removeTypingIndicator();
                DebugLog.aiResponse(logId, null, false, error.message);
                DebugLog.error('AI交互', '主对话API请求失败', { error: error.message, userMessage: userMessage });
                addMessage('assistant', `❌ 发生错误: ${error.message}`);
            }
        }

        function buildSystemPrompt() {
            const p = GameState.protagonist;
            const h = GameState.heroine;

            const personalityText = h.personality.map(id => {
                const trait = PersonalityTraits.find(t => t.id === id);
                const desc = h.personalityDesc[id] || trait?.defaultDesc;
                return `${trait?.name}: ${desc}`;
            }).join('\n');

            return `你是末世寝取生存游戏的叙事AI。

【世界观】极寒末世，文明崩溃，户外有致命寒流。

【当前状态】时间: ${formatGameTime()} ${GameState.gameTime.weekday}

【主角】${p.name}，${p.age}岁，有淫妻癖倾向

【女主角】${h.name}，${h.age}岁，${h.identity}，主角的${h.relation}
- 淫乱等级: ${h.corruptionLevel}星
- 出轨值: ${h.infidelityValue}%
- 处女状态: ${h.virginStatus}
- 性格特点:
${personalityText || '无特殊设定'}

【当前任务】${GameState.currentTasks.daily ? GameState.currentTasks.daily.content : '暂无'}

【写作要求】
1. 描写详细生动，感官细节丰富
2. 对话口语化，性爱场景直白露骨
3. 女主角高潮时叫声夸张（哦齁齁、咿咿咿等）
4. 女主角独自执行任务，主角享受隐奸快感
5. 结尾用【状态变化】标注数值变动`;
        }

        function processAIResponse(response, userMessage) {
            const changes = parseStateChanges(response);
            if (changes) {
                applyStateChanges(changes);
                DebugLog.info('状态解析', '从AI响应中解析到状态变化', changes);
            }

            const isSummary = response.includes('【总结完成】') || userMessage.includes('请对之前的剧情进行总结');

            addMessage('assistant', response, isSummary);
            updateAllUI();
        }

        function parseStateChanges(response) {
            const changes = {};
            const coinMatch = response.match(/寝取币\s*[+＋]\s*(\d+)/);
            if (coinMatch) changes.coins = parseInt(coinMatch[1]);
            const expMatch = response.match(/经验\s*[+＋]\s*(\d+)/);
            if (expMatch) changes.exp = parseInt(expMatch[1]);
            const infMatch = response.match(/出轨值\s*[+＋]\s*(\d+)/);
            if (infMatch) changes.infidelity = parseInt(infMatch[1]);
            return Object.keys(changes).length > 0 ? changes : null;
        }

        function applyStateChanges(changes) {
            if (changes.coins) {
                GameState.system.coins += changes.coins;
                showNotification(`💰 +${changes.coins} 寝取币`, 'success');
            }
            if (changes.exp) {
                GameState.system.exp += changes.exp;
                while (GameState.system.exp >= GameState.system.expToNext) {
                    GameState.system.exp -= GameState.system.expToNext;
                    GameState.system.level++;
                    GameState.system.expToNext = Math.floor(GameState.system.expToNext * 1.5);
                    showNotification(`🎉 升级到 Lv.${GameState.system.level}！`, 'success');
                    DebugLog.success('升级系统', `从AI响应升级到 Lv.${GameState.system.level}`);
                }
            }
            if (changes.infidelity) {
                GameState.heroine.infidelityValue = Math.min(100, GameState.heroine.infidelityValue + changes.infidelity);
            }
        }

        // ==================== 商店系统（带缓存） ====================
        async function searchShop() {
            const query = document.getElementById('shopSearchInput').value.trim();
            if (!query) {
                showNotification('请输入搜索内容', 'error');
                return;
            }

            const resultsContainer = document.getElementById('shopResults');
            const searchBtn = document.getElementById('shopSearchBtn');

            // 检查缓存中是否已有该搜索结果
            if (GameState.shopCache[query]) {
                DebugLog.info('商店系统', '从缓存中加载商品', { query: query, count: GameState.shopCache[query].length });
                displayShopItems(GameState.shopCache[query]);
                showNotification('📦 已从缓存加载商品', 'info');
                return;
            }

            searchBtn.disabled = true;
            resultsContainer.innerHTML = `
        <div class="shop-loading">
          <div class="shop-loading-spinner"></div>
          正在搜索商品...
        </div>
      `;

            DebugLog.info('商店系统', '开始搜索商品', { query: query });

            const prompt = `你是末世寝取生存游戏的商店系统。玩家搜索: "${query}"

请生成3-4个相关商品，严格按照JSON数组格式返回：
[
  {"name": "商品名", "desc": "描述20-40字", "price": 价格10-500, "effect": "效果描述"}
]

商品要符合现实(除非玩家搜索超自然物品)，只返回JSON数组。`;

            const logId = DebugLog.aiRequest('商店搜索', prompt, GameState.model);

            try {
                let fullResponse = '';
                await dzmm.completions({
                    model: GameState.model,
                    messages: [{ role: 'user', content: prompt }],
                    maxTokens: 800
                }, (content, done) => {
                    fullResponse = content;
                    if (done) {
                        DebugLog.aiResponse(logId, fullResponse, true);

                        try {
                            const jsonMatch = fullResponse.match(/\[[\s\S]*\]/);
                            if (jsonMatch) {
                                const items = JSON.parse(jsonMatch[0]);

                                // 保存到缓存
                                GameState.shopCache[query] = items;

                                // 添加到搜索历史（避免重复）
                                if (!GameState.shopSearchHistory.includes(query)) {
                                    GameState.shopSearchHistory.unshift(query);
                                    // 只保留最近10条搜索历史
                                    if (GameState.shopSearchHistory.length > 10) {
                                        GameState.shopSearchHistory.pop();
                                    }
                                }

                                displayShopItems(items);
                                updateShopHistory();
                                DebugLog.success('商店系统', '商品搜索成功并已缓存', { count: items.length, items: items });
                            } else {
                                throw new Error('无法从响应中解析JSON数组');
                            }
                        } catch (e) {
                            DebugLog.error('商店系统', '商品JSON解析失败', {
                                error: e.message,
                                response: fullResponse
                            });
                            resultsContainer.innerHTML = `<div class="shop-empty">生成失败，请重试</div>`;
                        }
                        searchBtn.disabled = false;
                    }
                });
            } catch (error) {
                DebugLog.aiResponse(logId, null, false, error.message);
                DebugLog.error('商店系统', '商品搜索API请求失败', { error: error.message });
                resultsContainer.innerHTML = `<div class="shop-empty">搜索失败: ${error.message}</div>`;
                searchBtn.disabled = false;
            }
        }

        // 从历史记录快速搜索
        function quickSearchFromHistory(query) {
            document.getElementById('shopSearchInput').value = query;
            searchShop();
        }

        // 更新搜索历史显示
        function updateShopHistory() {
            const container = document.getElementById('shopHistoryContainer');
            const tagsContainer = document.getElementById('shopHistoryTags');

            if (GameState.shopSearchHistory.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            tagsContainer.innerHTML = GameState.shopSearchHistory.map(query => `
        <span class="shop-history-tag" onclick="quickSearchFromHistory('${query}')">${query}</span>
      `).join('');
        }

        function displayShopItems(items) {
            const container = document.getElementById('shopResults');
            const coins = GameState.system.coins;

            container.innerHTML = items.map((item, i) => `
        <div class="shop-item" id="shop-item-${i}">
          <div class="shop-item-header">
            <div class="shop-item-name">${item.name}</div>
            <div class="shop-item-price">💰 ${item.price}</div>
          </div>
          <div class="shop-item-desc">${item.desc}</div>
          <div class="shop-item-effect">✨ ${item.effect}</div>
          <button class="shop-item-btn" onclick="buyItem(${i}, '${encodeURIComponent(JSON.stringify(item))}')"
                  ${coins < item.price ? 'disabled' : ''}>
            ${coins < item.price ? '余额不足' : '购买'}
          </button>
        </div>
      `).join('');
        }

        function buyItem(index, encodedItem) {
            const item = JSON.parse(decodeURIComponent(encodedItem));
            if (GameState.system.coins < item.price) {
                showNotification('寝取币不足！', 'error');
                DebugLog.warning('商店系统', '购买失败：余额不足', { item: item.name, price: item.price, coins: GameState.system.coins });
                return;
            }

            GameState.system.coins -= item.price;

            if (item.effect.includes('能力') || item.effect.includes('永久') || item.effect.includes('提升')) {
                GameState.abilities.push({ name: item.name, desc: item.effect });
                DebugLog.info('商店系统', '获得新能力', { name: item.name, effect: item.effect });
            } else {
                GameState.shelter.items.push(item.name);
                DebugLog.info('商店系统', '获得新物品', { name: item.name });
            }

            GameState.purchaseHistory.push({ name: item.name, price: item.price });
            updateAllUI();

            const btn = document.querySelector(`#shop-item-${index} .shop-item-btn`);
            if (btn) {
                btn.disabled = true;
                btn.textContent = '✅ 已购买';
            }

            showNotification(`✅ 购买成功: ${item.name}`, 'success');
            DebugLog.success('商店系统', '购买成功', { item: item.name, price: item.price });
        }

        function openShop() {
            document.getElementById('shopModal').classList.add('active');
            document.getElementById('shopCoins').textContent = `${GameState.system.coins} 💰`;
            document.getElementById('shopSearchInput').value = '';
            document.getElementById('shopResults').innerHTML = `<div class="shop-empty">🛍️ 输入关键词搜索商品</div>`;
            updateShopHistory();
            DebugLog.info('商店系统', '打开商店');
        }

        function closeShop() {
            document.getElementById('shopModal').classList.remove('active');
        }

        // ==================== 存档系统 ====================
        function openSaveModal() {
            document.getElementById('saveModal').classList.add('active');
            renderSaveSlots();
            DebugLog.info('存档系统', '打开存档管理');
        }

        function closeSaveModal() {
            document.getElementById('saveModal').classList.remove('active');
        }

        function renderSaveSlots() {
            const container = document.getElementById('saveSlots');

            for (let i = 0; i < 3; i++) {
                const saved = localStorage.getItem(`ntrGame_slot_${i}`);
                if (saved) {
                    try {
                        GameState.saves[i] = JSON.parse(saved);
                    } catch (e) {
                        GameState.saves[i] = null;
                        DebugLog.error('存档系统', `存档槽位${i}读取失败`, { error: e.message });
                    }
                }
            }

            container.innerHTML = GameState.saves.map((save, i) => {
                if (save) {
                    return `
            <div class="save-slot">
              <div class="save-slot-header">
                <div class="save-slot-name">存档 ${i + 1}</div>
                <div class="save-slot-time">${save.savedAt || '未知时间'}</div>
              </div>
              <div class="save-slot-info">
                ${save.protagonist?.name || '未知'} & ${save.heroine?.name || '未知'}<br>
                Lv.${save.system?.level || 1} | 💰${save.system?.coins || 0} | ⭐${save.heroine?.corruptionLevel || 1}
              </div>
              <div class="save-slot-actions">
                <button class="save-slot-btn save" onclick="saveToSlot(${i})">覆盖</button>
                <button class="save-slot-btn load" onclick="loadFromSlot(${i})">读取</button>
                <button class="save-slot-btn delete" onclick="deleteSlot(${i})">删除</button>
              </div>
            </div>
          `;
                } else {
                    return `
            <div class="save-slot">
              <div class="save-slot-header">
                <div class="save-slot-name">存档 ${i + 1}</div>
              </div>
              <div class="save-slot-info save-slot-empty">空存档</div>
              <div class="save-slot-actions">
                <button class="save-slot-btn save" onclick="saveToSlot(${i})">保存</button>
                <button class="save-slot-btn load" disabled>读取</button>
                <button class="save-slot-btn delete" disabled>删除</button>
              </div>
            </div>
          `;
                }
            }).join('');
        }

        function saveToSlot(slot) {
            try {
                const saveData = JSON.parse(JSON.stringify(GameState));
                saveData.savedAt = formatGameTime();
                saveData.saves = undefined;

                localStorage.setItem(`ntrGame_slot_${slot}`, JSON.stringify(saveData));
                GameState.saves[slot] = saveData;

                renderSaveSlots();
                showNotification(`✅ 已保存到存档 ${slot + 1}`, 'success');
                DebugLog.success('存档系统', `保存到存档槽位 ${slot + 1}`, { savedAt: saveData.savedAt });
            } catch (e) {
                DebugLog.error('存档系统', `保存到存档槽位${slot + 1}失败`, { error: e.message });
                showNotification('❌ 保存失败', 'error');
            }
        }

        function loadFromSlot(slot) {
            const saved = localStorage.getItem(`ntrGame_slot_${slot}`);
            if (!saved) {
                showNotification('存档不存在', 'error');
                DebugLog.warning('存档系统', `存档槽位${slot + 1}不存在`);
                return;
            }

            try {
                const saveData = JSON.parse(saved);
                const currentSaves = GameState.saves;

                Object.assign(GameState, saveData);
                GameState.saves = currentSaves;

                // 确保新增的字段有默认值
                if (!GameState.shopCache) GameState.shopCache = {};
                if (!GameState.shopSearchHistory) GameState.shopSearchHistory = [];

                renderChatHistory();

                updateAllUI();
                closeSaveModal();
                showNotification(`✅ 已加载存档 ${slot + 1}`, 'success');
                DebugLog.success('存档系统', `加载存档槽位 ${slot + 1}`, { savedAt: saveData.savedAt });
            } catch (e) {
                DebugLog.error('存档系统', `加载存档槽位${slot + 1}失败`, { error: e.message });
                showNotification('存档损坏', 'error');
            }
        }

        function renderChatHistory() {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';

            GameState.chatHistory.forEach((msg, index) => {
                const div = document.createElement('div');
                div.className = `message ${msg.role}${msg.isSummary ? ' summary' : ''}`;
                div.dataset.messageIndex = index;

                const sender = msg.role === 'user' ? GameState.protagonist.name : '系统叙述';
                const summaryBadge = msg.isSummary ? '<span class="summary-badge">📝 剧情总结</span>' : '';

                div.innerHTML = `
          <div class="message-sender">${sender}${summaryBadge}</div>
          <div class="message-bubble">${formatContent(msg.content)}</div>
        `;

                container.appendChild(div);
            });

            container.scrollTop = container.scrollHeight;
            updateLastMessageActions();
        }

        function deleteSlot(slot) {
            if (!confirm(`确定要删除存档 ${slot + 1} 吗？`)) return;

            localStorage.removeItem(`ntrGame_slot_${slot}`);
            GameState.saves[slot] = null;

            renderSaveSlots();
            showNotification(`🗑️ 已删除存档 ${slot + 1}`, 'info');
            DebugLog.info('存档系统', `删除存档槽位 ${slot + 1}`);
        }

        // ==================== 模型设置 ====================
        function openModelModal() {
            document.getElementById('modelModal').classList.add('active');
            document.getElementById('inGameModelSelect').value = GameState.model;
            document.getElementById('currentModelDisplay').textContent = GameState.model;
        }

        function closeModelModal() {
            document.getElementById('modelModal').classList.remove('active');
        }

        function applyModel() {
            const oldModel = GameState.model;
            GameState.model = document.getElementById('inGameModelSelect').value;
            document.getElementById('currentModelDisplay').textContent = GameState.model;
            closeModelModal();
            showNotification(`✅ 已切换到: ${GameState.model}`, 'success');
            DebugLog.info('模型设置', `切换模型: ${oldModel} -> ${GameState.model}`);
        }

        // ==================== 用户交互 ====================
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            input.style.height = 'auto';

            addMessage('user', message);
            showTypingIndicator();
            document.getElementById('sendBtn').disabled = true;

            await sendToAI(message);

            document.getElementById('sendBtn').disabled = false;
        }

        function quickAction(action) {
            document.getElementById('userInput').value = action;
            sendMessage();
            DebugLog.info('快捷操作', `执行快捷操作: ${action}`);
        }

        // ==================== 游戏启动 ====================
        async function startGame() {
            DebugLog.info('游戏启动', '开始初始化游戏...');

            GameState.model = document.getElementById('modelSelect').value;
            GameState.protagonist.name = document.getElementById('protagonistName').value || '陈默';
            let pAge = parseInt(document.getElementById('protagonistAge').value) || 22;
            GameState.protagonist.age = Math.max(18, pAge);
            GameState.heroine.name = document.getElementById('heroineName').value || '林雨晴';
            let hAge = parseInt(document.getElementById('heroineAge').value) || 21;
            GameState.heroine.age = Math.max(18, hAge);
            GameState.heroine.relation = document.getElementById('heroineRelation').value || '女友';
            GameState.heroine.identity = document.getElementById('heroineIdentity').value || '大学校花';

            const virginSelect = document.getElementById('virginSelect').value;
            if (virginSelect === 'yes') {
                GameState.heroine.virginStatus = '完璧';
            } else {
                const selectedOption = document.querySelector('.radio-option.selected input');
                if (selectedOption) {
                    const value = selectedOption.value;
                    if (value === 'protagonist') {
                        GameState.heroine.virginStatus = `被${GameState.protagonist.name}夺走`;
                    } else if (value === 'other') {
                        GameState.heroine.virginStatus = '被其他人夺走';
                    } else if (value === 'custom') {
                        GameState.heroine.virginStatus = document.getElementById('customVirginText').value || '被其他人夺走';
                    }
                } else {
                    GameState.heroine.virginStatus = '被其他人夺走';
                }
            }

            const selectedTags = document.querySelectorAll('.personality-tag.selected');
            GameState.heroine.personality = Array.from(selectedTags).map(tag => tag.dataset.id);

            DebugLog.success('游戏启动', '角色设置完成', {
                protagonist: GameState.protagonist,
                heroine: {
                    name: GameState.heroine.name,
                    age: GameState.heroine.age,
                    relation: GameState.heroine.relation,
                    identity: GameState.heroine.identity,
                    personality: GameState.heroine.personality,
                    virginStatus: GameState.heroine.virginStatus
                },
                model: GameState.model
            });

            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';

            updateAllUI();

            DebugLog.info('游戏启动', '开始生成初始任务...');
            await generateDailyTask();

            showTypingIndicator();

            const personalityText = GameState.heroine.personality.map(id => {
                const trait = PersonalityTraits.find(t => t.id === id);
                return trait?.name;
            }).filter(Boolean).join('、') || '普通';

            const openingPrompt = `游戏开始。生成开场剧情：

主角${GameState.protagonist.name}（${GameState.protagonist.age}岁）在末日寒流后，与${GameState.heroine.relation}${GameState.heroine.name}（${GameState.heroine.age}岁，${GameState.heroine.identity}，性格：${personalityText}）躲在避难所内。

女主角处女状态：${GameState.heroine.virginStatus}

描写：
1. 避难所环境
2. 两人的亲密互动（体现女主角的性格特点）
3. 系统首次激活
4. 提醒用户查看侧边栏的任务

叙事细腻，对话生动。`;

            DebugLog.info('游戏启动', '开始生成开场剧情...');
            await sendToAI(openingPrompt);
            DebugLog.success('游戏启动', '游戏初始化完成');
        }

        // ==================== 事件监听 ====================
        document.getElementById('userInput').addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        document.getElementById('userInput').addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function (e) {
                if (e.target === this) this.classList.remove('active');
            });
        });

        // ==================== 初始化 ====================
        initPersonalityTags();
        DebugLog.info('系统初始化', '页面加载完成，等待用户开始游戏');

        function handleResize() {
            const panel = document.getElementById('sidePanel');
            const chat = document.getElementById('chatContainer');
            const overlay = document.getElementById('mobileOverlay');
            const btn = document.getElementById('togglePanelBtn');

            if (isMobile()) {
                panel.classList.remove('collapsed');
                chat.classList.remove('expanded');
                if (!panel.classList.contains('mobile-visible')) {
                    overlay.classList.remove('active');
                    btn.classList.remove('active');
                }
            } else {
                panel.classList.remove('mobile-visible');
                overlay.classList.remove('active');
                btn.classList.remove('active');
                panel.classList.remove('collapsed');
                chat.classList.remove('expanded');
            }
        }

        window.addEventListener('resize', handleResize);
        handleResize();

        if (typeof dzmm === 'undefined') {
            DebugLog.error('系统初始化', 'dzmm对象未定义，AI功能将无法使用', {
                hint: '请确保在支持dzmm的环境中运行'
            });
        } else {
            DebugLog.success('系统初始化', 'dzmm对象已就绪');
        }
    </script>


</body>

</html>